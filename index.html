<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .priority-High { background-color: #fed7d7; color: #c53030; }
        .priority-Medium { background-color: #feebc8; color: #dd6b20; }
        .priority-Low { background-color: #c6f6d5; color: #2f855a; }
        .calendar-day.today { background-color: #ebf8ff; border: 1px solid #90cdf4; }
        .calendar-day:hover { background-color: #f7fafc; }
        .habit-checkbox:checked + label { text-decoration: line-through; color: #a0aec0; }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-3xl font-bold text-slate-800">Life OS - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h1>
            <p class="text-slate-500">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Row 1: My Website -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üåê</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                    </div>
                    <a href="https://jenprpa.github.io/TM/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                <div class="w-full h-96 border border-slate-200 rounded-lg overflow-hidden">
                    <iframe src="https://jenprpa.github.io/TM/" class="w-full h-full" title="My Embedded Website"></iframe>
                </div>
            </div>

            <!-- Row 2: Task Management -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üóÇÔ∏è</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h2>
                    </div>
                    <button onclick="openTaskModal()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="task-board">
                    <!-- Columns will be generated by JS -->
                </div>
            </div>

            <!-- Row 3: Planner -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                 <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÖ</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
                    </div>
                     <button onclick="openScheduleModal()" class="bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-cyan-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                </div>
                <div id="calendar-container">
                    <!-- Calendar will be generated by JS -->
                </div>
            </div>

            <!-- Row 4: Habit Tracker -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üéØ</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                    </div>
                    <button onclick="openHabitModal()" class="bg-teal-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-teal-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</button>
                </div>
                <div id="habit-tracker-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Habits will be generated by JS -->
                </div>
            </div>

            <!-- Row 5: Daily Journal -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                 <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìì</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                    </div>
                    <button onclick="openJournalModal()" class="bg-purple-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-purple-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                <div id="journal-entries" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Entries will be generated by JS -->
                </div>
            </div>
            
            <!-- Row 6: Knowledge Hub -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                       <span class="text-2xl mr-3">üìö</span>
                       <h2 class="text-xl font-semibold text-gray-900">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</h2>
                    </div>
                    <button onclick="openKnowledgeModal()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</button>
                </div>
                <div id="knowledge-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                    <!-- Knowledge cards will be generated by JS -->
                </div>
            </div>

            <!-- Row 7: Budget Tracker -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üí∞</span>
                        <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
                    </div>
                    <button onclick="openBudgetModal()" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-emerald-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-green-100 p-3 rounded-lg"><p class="text-sm text-green-800">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p id="total-income" class="text-xl font-bold text-green-600">‡∏ø0.00</p></div>
                    <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p id="total-expense" class="text-xl font-bold text-red-600">‡∏ø0.00</p></div>
                    <div class="bg-blue-100 p-3 rounded-lg"><p class="text-sm text-blue-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p id="balance" class="text-xl font-bold text-blue-600">‡∏ø0.00</p></div>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 sticky top-0"><tr><th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-3"></th></tr></thead>
                        <tbody id="budget-table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://aajlqfearyhlpwjcqjom.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhamxxZmVhcnlobHB3amNxam9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NjI0MzgsImV4cCI6MjA2OTUzODQzOH0.v9JRorJeSvGdAdZbvr1QHdAw9DaewpySUJ-ZiWr14nY';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let currentViewDate = new Date();
        let currentCalendarView = 'month';
        let allCalendarItems = [];
        let dailyExpenses = new Map();

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
        const formatTime = (dateString) => new Date(dateString).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const getToday = () => new Date().toISOString().split('T')[0];

        // --- MODAL HANDLING ---
        const modalContainer = document.getElementById('modal-container');
        function closeModal() { modalContainer.innerHTML = ''; }
        
        // --- TASK MANAGEMENT ---
        function openTaskModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-task-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3><div class="space-y-4"><div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input name="title" type="text" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label><input name="due_date" type="date" value="${getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><select name="priority" class="w-full mt-1 p-2 border rounded-md"><option>Low</option><option selected>Medium</option><option>High</option></select></div><div><label class="text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select name="status" class="w-full mt-1 p-2 border rounded-md"><option>To-Do</option><option>In Progress</option><option>Done</option></select></div></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-task-form').addEventListener('submit', addTask); }
        async function addTask(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const taskData = Object.fromEntries(formData.entries()); const { error } = await db.from('tasks').insert([taskData]); if (error) { console.error('Error adding task:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchTasks(); fetchDataForCalendar(); closeModal(); } }
        async function fetchTasks() { const { data: tasks, error } = await db.from('tasks').select('*').order('created_at', { ascending: false }); if (error) { console.error('Error fetching tasks:', error); return; } renderTaskBoard(tasks); }
        function renderTaskBoard(tasks) { const board = document.getElementById('task-board'); board.innerHTML = ''; const statuses = ['To-Do', 'In Progress', 'Done']; statuses.forEach(status => { const column = document.createElement('div'); column.className = 'bg-slate-100 rounded-lg p-3'; const tasksInStatus = tasks.filter(t => t.status === status); let tasksHTML = tasksInStatus.map(task => `<div class="bg-white p-3 rounded-md shadow-sm border border-slate-200 mb-2"><p class="font-semibold text-slate-800">${task.title}</p><div class="text-xs text-slate-500 mt-2">‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatDate(task.due_date)}</div><div class="mt-2 flex justify-between items-center"><span class="text-xs font-medium px-2 py-1 rounded-full priority-${task.priority}">${task.priority}</span><button onclick="deleteTask(${task.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); column.innerHTML = `<h3 class="font-semibold text-slate-700 mb-3">${status} (${tasksInStatus.length})</h3><div class="space-y-2 min-h-[100px]">${tasksHTML}</div>`; board.appendChild(column); }); }
        async function deleteTask(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; const { error } = await db.from('tasks').delete().eq('id', id); if (error) { console.error('Error deleting task:', error); } else { fetchTasks(); fetchDataForCalendar(); } }

        // --- BUDGET TRACKER ---
        function openBudgetModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-budget-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h3><div class="space-y-4"><div><label class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input name="item" type="text" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input name="amount" type="number" step="0.01" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="transaction_date" type="date" value="${getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="transaction_type" class="w-full mt-1 p-2 border rounded-md"><option value="Income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="Expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></div><div><label class="text-sm font-medium">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input name="category" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" required class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-budget-form').addEventListener('submit', addBudgetItem); }
        async function addBudgetItem(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const budgetData = Object.fromEntries(formData.entries()); budgetData.amount = parseFloat(budgetData.amount); const { error } = await db.from('budget').insert([budgetData]); if (error) { console.error('Error adding budget item:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchBudget(); fetchDataForCalendar(); closeModal(); } }
        async function fetchBudget() { const { data: budgetItems, error } = await db.from('budget').select('*').order('transaction_date', { ascending: false }); if (error) { console.error('Error fetching budget:', error); return; } renderBudgetTable(budgetItems); updateBudgetSummary(budgetItems); }
        function renderBudgetTable(items) { const tableBody = document.getElementById('budget-table-body'); tableBody.innerHTML = items.map(item => `<tr class="border-b"><td class="p-3 font-medium">${item.item}</td><td class="p-3 ${item.transaction_type === 'Income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(item.amount)}</td><td class="p-3 text-slate-500">${formatDate(item.transaction_date)}</td><td class="p-3"><span class="bg-slate-200 text-slate-800 px-2 py-1 text-xs rounded-full">${item.category}</span></td><td class="p-3 text-xs font-semibold">${item.transaction_type}</td><td class="p-3"><button onclick="deleteBudgetItem(${item.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td></tr>`).join(''); }
        function updateBudgetSummary(items) { const totalIncome = items.filter(i => i.transaction_type === 'Income').reduce((sum, i) => sum + i.amount, 0); const totalExpense = items.filter(i => i.transaction_type === 'Expense').reduce((sum, i) => sum + i.amount, 0); const balance = totalIncome - totalExpense; document.getElementById('total-income').textContent = formatCurrency(totalIncome); document.getElementById('total-expense').textContent = formatCurrency(totalExpense); document.getElementById('balance').textContent = formatCurrency(balance); }
        async function deleteBudgetItem(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; const { error } = await db.from('budget').delete().eq('id', id); if (error) console.error('Error deleting budget item:', error); else { fetchBudget(); fetchDataForCalendar(); } }
        
        // --- KNOWLEDGE HUB ---
        function openKnowledgeModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-knowledge-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</h3><div class="space-y-4"><div><label class="text-sm font-medium">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input name="topic" type="text" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏™‡∏£‡∏∏‡∏õ</label><textarea name="summary" class="w-full mt-1 p-2 border rounded-md"></textarea></div><div><label class="text-sm font-medium">URL</label><input name="url" type="url" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">Tags (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ ,)</label><input name="tags" type="text" class="w-full mt-1 p-2 border rounded-md"></div></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-knowledge-form').addEventListener('submit', addKnowledgeItem); }
        async function addKnowledgeItem(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const knowledgeData = Object.fromEntries(formData.entries()); knowledgeData.tags = knowledgeData.tags.split(',').map(tag => tag.trim()).filter(tag => tag); const { error } = await db.from('knowledge_base').insert([knowledgeData]); if (error) { console.error('Error adding knowledge item:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchKnowledge(); closeModal(); } }
        async function fetchKnowledge() { const { data, error } = await db.from('knowledge_base').select('*').order('created_at', { ascending: false }); if (error) { console.error('Error fetching knowledge base:', error); return; } renderKnowledgeGallery(data); }
        function renderKnowledgeGallery(items) { const gallery = document.getElementById('knowledge-gallery'); gallery.innerHTML = items.map(item => `<div class="bg-slate-50 border border-slate-200 rounded-lg p-4"><div class="flex justify-between items-start"><h4 class="font-semibold text-slate-800 mb-2">${item.topic}</h4><button onclick="deleteKnowledge(${item.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button></div><p class="text-sm text-slate-600 mb-3">${item.summary || ''}</p><div class="flex flex-wrap gap-1 mb-3">${(item.tags || []).map(tag => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${tag}</span>`).join('')}</div>${item.url ? `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="fa-solid fa-link text-xs"></i></a>` : ''}</div>`).join(''); }
        async function deleteKnowledge(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; const { error } = await db.from('knowledge_base').delete().eq('id', id); if (error) console.error('Error deleting knowledge item:', error); else fetchKnowledge(); }
        
        // --- JOURNAL ---
        function openJournalModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-journal-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3><div class="space-y-4"><div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="entry_date" type="date" value="${getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì</label><textarea name="gratitude" class="w-full mt-1 p-2 border rounded-md"></textarea></div><div><label class="text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ</label><textarea name="small_wins" class="w-full mt-1 p-2 border rounded-md"></textarea></div><div><label class="text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label><textarea name="mood_check_in" class="w-full mt-1 p-2 border rounded-md"></textarea></div></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-journal-form').addEventListener('submit', addJournalEntry); }
        async function addJournalEntry(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const journalData = Object.fromEntries(formData.entries()); const { error } = await db.from('journal_entries').insert([journalData]); if (error) { console.error('Error adding journal entry:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchJournal(); closeModal(); } }
        async function fetchJournal() { const { data, error } = await db.from('journal_entries').select('*').order('entry_date', { ascending: false }); if (error) { console.error('Error fetching journal entries:', error); return; } renderJournal(data); }
        function renderJournal(items) { const container = document.getElementById('journal-entries'); container.innerHTML = items.map(entry => `<div class="bg-slate-50 rounded-lg p-4 border-l-4 border-purple-400"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-gray-800">${formatDate(entry.entry_date)}</h4><button onclick="deleteJournal(${entry.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button></div><div class="space-y-2 text-sm text-slate-700">${entry.gratitude ? `<div><strong>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì:</strong> ${entry.gratitude}</div>` : ''}${entry.small_wins ? `<div><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${entry.small_wins}</div>` : ''}${entry.mood_check_in ? `<div><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å:</strong> ${entry.mood_check_in}</div>` : ''}</div></div>`).join(''); }
        async function deleteJournal(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; const { error } = await db.from('journal_entries').delete().eq('id', id); if (error) console.error('Error deleting journal entry:', error); else fetchJournal(); }

        // --- SCHEDULE / CALENDAR ---
        function openScheduleModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-schedule-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3><div class="space-y-4"><div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input name="title" type="text" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="event_type" class="w-full mt-1 p-2 border rounded-md"><option>Personal</option><option>Work</option><option>Health</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input name="start_date" type="date" value="${currentViewDate.toISOString().split('T')[0]}" required class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input name="start_time" type="time" required class="w-full mt-1 p-2 border rounded-md"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input name="end_date_val" type="date" class="w-full mt-1 p-2 border rounded-md"></div><div><label class="text-sm font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input name="end_time" type="time" class="w-full mt-1 p-2 border rounded-md"></div></div></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-schedule-form').addEventListener('submit', addScheduleItem); }
        async function addScheduleItem(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const data = Object.fromEntries(formData.entries()); const event_date = `${data.start_date}T${data.start_time}:00`; const end_date = data.end_date_val && data.end_time ? `${data.end_date_val}T${data.end_time}:00` : null; const { error } = await db.from('schedule').insert([{ title: data.title, event_type: data.event_type, event_date: event_date, end_date: end_date }]); if (error) { console.error('Error adding schedule item:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchDataForCalendar(); closeModal(); } }
        async function fetchDataForCalendar() {
            const [eventsRes, tasksRes, budgetRes] = await Promise.all([ db.from('schedule').select('*'), db.from('tasks').select('*'), db.from('budget').select('amount, transaction_date, transaction_type') ]);
            if (eventsRes.error || tasksRes.error || budgetRes.error) { console.error('Error fetching calendar data:', eventsRes.error || tasksRes.error || budgetRes.error); return; }
            const formattedEvents = eventsRes.data.map(e => ({ id: `event-${e.id}`, date: new Date(e.event_date), endDate: e.end_date ? new Date(e.end_date) : null, title: e.title, type: 'event', originalData: e }));
            const formattedTasks = tasksRes.data.map(t => ({ id: `task-${t.id}`, date: new Date(t.due_date + 'T00:00:00'), endDate: null, title: t.title, type: 'task', originalData: t }));
            allCalendarItems = [...formattedEvents, ...formattedTasks];
            dailyExpenses.clear();
            budgetRes.data.forEach(item => { if (item.transaction_type === 'Expense') { const dateStr = item.transaction_date; const currentTotal = dailyExpenses.get(dateStr) || 0; dailyExpenses.set(dateStr, currentTotal + item.amount); } });
            renderCalendar();
        }
        async function deleteScheduleItem(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; const { error } = await db.from('schedule').delete().eq('id', id); if (error) console.error('Error deleting schedule item:', error); else fetchDataForCalendar(); }
        function switchCalendarView(view) { currentCalendarView = view; renderCalendar(); }
        function navigateCalendar(amount) { if (currentCalendarView === 'month') { currentViewDate.setMonth(currentViewDate.getMonth() + amount); } else if (currentCalendarView === 'week') { currentViewDate.setDate(currentViewDate.getDate() + (amount * 7)); } else { currentViewDate.setDate(currentViewDate.getDate() + amount); } renderCalendar(); }
        function renderCalendar() {
            const container = document.getElementById('calendar-container'); let header = `<div class="flex items-center justify-between mb-4"><button onclick="navigateCalendar(-1)" class="p-2 rounded-full hover:bg-slate-100"><i class="fa-solid fa-chevron-left"></i></button><h3 class="text-lg font-semibold text-center"></h3><button onclick="navigateCalendar(1)" class="p-2 rounded-full hover:bg-slate-100"><i class="fa-solid fa-chevron-right"></i></button></div><div class="flex items-center justify-center space-x-1 mb-4 p-1 bg-slate-100 rounded-lg"><button onclick="switchCalendarView('month')" class="view-btn ${currentCalendarView === 'month' ? 'bg-white shadow' : ''} w-full text-sm px-3 py-1 rounded-md">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button><button onclick="switchCalendarView('week')" class="view-btn ${currentCalendarView === 'week' ? 'bg-white shadow' : ''} w-full text-sm px-3 py-1 rounded-md">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button><button onclick="switchCalendarView('day')" class="view-btn ${currentCalendarView === 'day' ? 'bg-white shadow' : ''} w-full text-sm px-3 py-1 rounded-md">‡∏ß‡∏±‡∏ô</button></div>`;
            container.innerHTML = header + `<div id="calendar-view"></div>`; const viewContainer = document.getElementById('calendar-view'); const headerText = container.querySelector('h3');
            if (currentCalendarView === 'month') { headerText.textContent = currentViewDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); renderMonthlyView(viewContainer); } 
            else if (currentCalendarView === 'week') { const startOfWeek = new Date(currentViewDate); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(endOfWeek.getDate() + 6); headerText.textContent = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`; renderWeeklyView(viewContainer); } 
            else { headerText.textContent = currentViewDate.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); renderDailyView(viewContainer); }
        }
        function renderMonthlyView(container) {
            const year = currentViewDate.getFullYear(); const month = currentViewDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); let daysHtml = `<div class="grid grid-cols-7 gap-1 text-center text-sm">`; const dayHeaders = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™']; daysHtml += dayHeaders.map(d => `<div class="font-bold text-slate-500 py-2">${d}</div>`).join('');
            for (let i = 0; i < firstDay.getDay(); i++) { daysHtml += `<div></div>`; }
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayDate = new Date(year, month, i); const dateStr = dayDate.toISOString().split('T')[0]; const isToday = dateStr === getToday() ? 'today' : '';
                const eventsOnDay = allCalendarItems.filter(e => new Date(e.date).toDateString() === dayDate.toDateString() && e.type === 'event');
                const tasksOnDay = allCalendarItems.filter(e => new Date(e.date).toDateString() === dayDate.toDateString() && e.type === 'task');
                const expenseTotal = dailyExpenses.get(dateStr);
                daysHtml += `<div class="calendar-day p-1 rounded-lg cursor-pointer h-20 border ${isToday} flex flex-col"><div class="font-semibold text-left">${i}</div><div class="flex-grow overflow-hidden"><div class="flex justify-start space-x-1">${eventsOnDay.slice(0, 2).map(() => `<div class="w-1.5 h-1.5 bg-cyan-500 rounded-full"></div>`).join('')}${tasksOnDay.slice(0, 2).map(() => `<div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>`).join('')}</div>${expenseTotal ? `<div class="text-xs text-red-500 text-right mt-1 truncate">-‡∏ø${expenseTotal.toLocaleString()}</div>` : ''}</div></div>`;
            }
            daysHtml += `</div>`; container.innerHTML = daysHtml;
        }
        function renderWeeklyView(container) {
            let weekHtml = `<div class="grid grid-cols-7 gap-2 text-sm">`; const startOfWeek = new Date(currentViewDate); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            for (let i = 0; i < 7; i++) { const day = new Date(startOfWeek); day.setDate(day.getDate() + i); const itemsOnDay = allCalendarItems.filter(e => new Date(e.date).toDateString() === day.toDateString()).sort((a, b) => a.date - b.date); weekHtml += `<div class="p-2 border rounded-lg"><div class="text-center font-bold">${day.toLocaleDateString('th-TH', { weekday: 'short' })} ${day.getDate()}</div><div class="mt-2 space-y-1">${itemsOnDay.map(item => { if (item.type === 'event') { return `<div class="bg-cyan-100 text-cyan-800 p-1 rounded text-xs truncate">${formatTime(item.date)} ${item.title}</div>`; } else { return `<div class="bg-blue-100 text-blue-800 p-1 rounded text-xs truncate"><i class="fa-solid fa-check-square mr-1"></i>${item.title}</div>`; } }).join('') || '<div class="h-10"></div>'}</div></div>`; }
            weekHtml += `</div>`; container.innerHTML = weekHtml;
        }
        function renderDailyView(container) {
            const dateStr = currentViewDate.toISOString().split('T')[0];
            const eventsOnDay = allCalendarItems.filter(e => new Date(e.date).toDateString() === currentViewDate.toDateString() && e.type === 'event').sort((a, b) => a.date - b.date);
            const tasksOnDay = allCalendarItems.filter(e => new Date(e.date).toDateString() === currentViewDate.toDateString() && e.type === 'task');
            const expenseTotal = dailyExpenses.get(dateStr);
            let dayHtml = `<div class="space-y-4">`;
            if (expenseTotal) { dayHtml += `<div><h4 class="font-semibold text-slate-600 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h4><div class="p-3 rounded-lg bg-red-50 text-red-600 font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${formatCurrency(expenseTotal)}</div></div>`; }
            if (eventsOnDay.length > 0) { dayHtml += `<div><h4 class="font-semibold text-slate-600 mb-2">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4><div class="space-y-3">${eventsOnDay.map(e => `<div class="p-3 rounded-lg bg-slate-100 flex items-start space-x-4"><div class="text-sm text-cyan-600 font-semibold w-24"><div>${formatTime(e.date)}</div>${e.endDate ? `<div class="text-xs">‡∏ñ‡∏∂‡∏á ${formatTime(e.endDate)}</div>` : ''}</div><div class="flex-grow"><p class="font-semibold text-slate-800">${e.title}</p><p class="text-xs text-slate-500">${e.originalData.event_type}</p></div><button onclick="deleteScheduleItem(${e.originalData.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button></div>`).join('')}</div></div>`; }
            if (tasksOnDay.length > 0) { dayHtml += `<div><h4 class="font-semibold text-slate-600 mb-2">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4><div class="space-y-3">${tasksOnDay.map(t => `<div class="p-3 rounded-lg bg-slate-100 flex items-center space-x-4"><div class="flex-grow"><p class="font-semibold text-slate-800">${t.title}</p></div><span class="text-xs font-medium px-2 py-1 rounded-full priority-${t.originalData.priority}">${t.originalData.priority}</span></div>`).join('')}</div></div>`; }
            if (eventsOnDay.length === 0 && tasksOnDay.length === 0) { dayHtml += `<div class="text-center text-slate-400 p-8"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p></div>`; }
            dayHtml += `</div>`; container.innerHTML = dayHtml;
        }

        // --- HABIT TRACKER ---
        function openHabitModal() { modalContainer.innerHTML = `<div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><form id="add-habit-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</h3><div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</label><input name="name" type="text" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢, ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" class="w-full mt-1 p-2 border rounded-md"></div><div class="mt-6 flex justify-end space-x-2"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.getElementById('add-habit-form').addEventListener('submit', addHabit); }
        async function addHabit(e) { e.preventDefault(); const form = e.target; const formData = new FormData(form); const habitData = Object.fromEntries(formData.entries()); const { error } = await db.from('habits').insert([habitData]); if (error) { console.error('Error adding habit:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ: ' + error.message); } else { fetchHabits(); closeModal(); } }
        async function fetchHabits() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];

            const { data: habits, error: habitsError } = await db.from('habits').select('*').order('created_at');
            const { data: log, error: logError } = await db.from('habit_log').select('*').gte('completed_date', startOfMonth);
            
            if (habitsError || logError) { console.error('Error fetching habits:', habitsError || logError); return; }
            
            const habitStats = calculateHabitStats(habits, log);
            renderHabitTracker(habitStats, log);
        }
        function calculateHabitStats(habits, log) {
            const today = new Date();
            const todayStr = getToday();
            
            return habits.map(habit => {
                const habitLogs = log.filter(l => l.habit_id === habit.id);
                const logDates = new Set(habitLogs.map(l => l.completed_date));

                // Calculate Streak
                let streak = 0;
                if (logDates.has(todayStr)) {
                    streak = 1;
                    let currentDate = new Date(today);
                    currentDate.setDate(currentDate.getDate() - 1);
                    while (logDates.has(currentDate.toISOString().split('T')[0])) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    }
                } else {
                    let yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (logDates.has(yesterday.toISOString().split('T')[0])) {
                         let currentDate = yesterday;
                         while (logDates.has(currentDate.toISOString().split('T')[0])) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        }
                    }
                }

                // Calculate Weekly Percentage
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                let weekCompleted = 0;
                for (let i = 0; i <= today.getDay(); i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(day.getDate() + i);
                    if (logDates.has(day.toISOString().split('T')[0])) {
                        weekCompleted++;
                    }
                }
                const weekPercent = Math.round((weekCompleted / (today.getDay() + 1)) * 100);

                // Calculate Monthly Percentage
                const monthCompleted = habitLogs.length;
                const monthPercent = Math.round((monthCompleted / today.getDate()) * 100);

                // Weekly Graph Data
                let graphData = [];
                for (let i = 6; i >= 0; i--) {
                    const day = new Date(today);
                    day.setDate(day.getDate() - i);
                    graphData.push(logDates.has(day.toISOString().split('T')[0]));
                }

                return { ...habit, stats: { streak, weekPercent, monthPercent, graphData } };
            });
        }
        function renderHabitTracker(habitsWithStats, log) {
            const container = document.getElementById('habit-tracker-container');
            const completedHabitIds = new Set(log.filter(l => l.completed_date === getToday()).map(item => item.habit_id));
            
            container.innerHTML = habitsWithStats.map(habit => {
                const { streak, weekPercent, monthPercent, graphData } = habit.stats;
                const graphHTML = graphData.map(completed => 
                    `<div class="w-full h-6 ${completed ? 'bg-teal-500' : 'bg-slate-200'} rounded-sm"></div>`
                ).join('');

                return `
                <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="habit-${habit.id}" data-habit-id="${habit.id}" onchange="toggleHabit(this)" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500 habit-checkbox" ${completedHabitIds.has(habit.id) ? 'checked' : ''}>
                            <label for="habit-${habit.id}" class="ml-3 text-slate-800 font-semibold">${habit.name}</label>
                        </div>
                        <button onclick="deleteHabit(${habit.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        <div class="flex justify-around text-center text-sm">
                            <div>
                                <div class="font-bold text-teal-600">${streak} ‡∏ß‡∏±‡∏ô</div>
                                <div class="text-xs text-slate-500">‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á üî•</div>
                            </div>
                            <div>
                                <div class="font-bold text-teal-600">${weekPercent}%</div>
                                <div class="text-xs text-slate-500">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</div>
                            </div>
                            <div>
                                <div class="font-bold text-teal-600">${monthPercent}%</div>
                                <div class="text-xs text-slate-500">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                            </div>
                        </div>
                        <div class="mt-4">
                             <div class="text-xs text-slate-500 mb-1 text-center">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                             <div class="grid grid-cols-7 gap-1">${graphHTML}</div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        async function toggleHabit(checkbox) { 
            const habitId = checkbox.dataset.habitId; 
            const completed = checkbox.checked; 
            if (completed) { 
                const { error } = await db.from('habit_log').insert([{ habit_id: habitId, completed_date: getToday() }]); 
                if (error) console.error('Error logging habit:', error);
            } else { 
                const { error } = await db.from('habit_log').delete().match({ habit_id: habitId, completed_date: getToday() }); 
                if (error) console.error('Error un-logging habit:', error);
            }
            fetchHabits(); // Re-fetch to update stats
        }
        async function deleteHabit(id) { if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢)')) return; const { error } = await db.from('habits').delete().eq('id', id); if (error) console.error('Error deleting habit:', error); else fetchHabits(); }

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            if (db) {
                fetchTasks();
                fetchBudget();
                fetchKnowledge();
                fetchJournal();
                fetchDataForCalendar();
                fetchHabits();
            } else {
                alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
            }
        });
    </script>

</body>
</html>
