<!DOCTYPE html>
<html lang="th" class="theme-slate"> <!-- [NEW] Default theme class -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Life Dashboard - ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        /* [NEW] CSS Variables for Theming */
        :root.theme-slate {
            --color-primary-50: #f8fafc; --color-primary-100: #f1f5f9; --color-primary-200: #e2e8f0;
            --color-primary-700: #334155; --color-primary-800: #1e293b; --color-primary-900: #0f172a;
        }
        :root.theme-sky {
            --color-primary-50: #f0f9ff; --color-primary-100: #e0f2fe; --color-primary-200: #bae6fd;
            --color-primary-700: #0369a1; --color-primary-800: #075985; --color-primary-900: #0c4a6e;
        }
        :root.theme-emerald {
            --color-primary-50: #ecfdf5; --color-primary-100: #d1fae5; --color-primary-200: #a7f3d0;
            --color-primary-700: #047857; --color-primary-800: #065f46; --color-primary-900: #064e3b;
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--color-primary-100); }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .priority-High { background-color: #fed7d7; color: #c53030; }
        .priority-Medium { background-color: #feebc8; color: #dd6b20; }
        .priority-Low { background-color: #c6f6d5; color: #2f855a; }
        .calendar-day.today { background-color: #ebf8ff; border: 1px solid #90cdf4; font-weight: bold; }
        .calendar-day:hover { background-color: #f7fafc; }
        .habit-checkbox:checked + label { text-decoration: line-through; color: #a0aec0; }
        .sidebar-link.active { background-color: rgba(255, 255, 255, 0.1); border-left-color: #4299e1; color: white; }
        .progress-bar { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { background-color: #4299e1; border-radius: 9999px; transition: width 0.3s ease-in-out; }
        .mood-btn.selected { transform: scale(1.2); border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); }
        .habit-item.dragging { opacity: 0.5; background: #f0f8ff; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        /* [NEW] Themed elements */
        .themed-bg-800 { background-color: var(--color-primary-800); }
        .themed-bg-700-hover:hover { background-color: var(--color-primary-700); }
        .themed-bg-100 { background-color: var(--color-primary-100); }
        .themed-text-200 { color: var(--color-primary-200); }
    </style>
</head>
<body class="themed-bg-100">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="themed-bg-800 themed-text-200 w-64 space-y-2 py-4 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-50 flex flex-col">
            <h2 class="px-4 text-2xl font-bold text-white mb-4">‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</h2>
            <nav id="sidebar-nav" class="flex-1 flex flex-col">
                <a href="#overview" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üè†</span> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a>
                <a href="#website" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üåê</span> ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</a>
                <a href="#weekly-agenda" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üóìÔ∏è</span> ‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</a>
                <a href="#okrs" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üöÄ</span> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (OKRs)</a>
                <a href="#tasks" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üóÇÔ∏è</span> ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</a>
                <a href="#ideas" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üí°</span> ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</a>
                <a href="#planner" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üìÖ</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</a>
                <a href="#habits" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üéØ</span> ‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</a>
                <a href="#health-tracker" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">‚ù§Ô∏è</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</a>
                <a href="#mood-tracker" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üòä</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</a>
                <a href="#media-log" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üé¨</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡∏î‡∏π/‡∏ü‡∏±‡∏á</a>
                <a href="#event-log" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üìå</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</a>
                <a href="#personal-growth" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üå±</span> ‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</a>
                <a href="#certificates" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üèÜ</span> ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</a>
                <a href="#journal" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üìì</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</a>
                <a href="#knowledge" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üìö</span> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</a>
                <a href="#budget" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üí∞</span> ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</a>
                <a href="#finance-app" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üí∏</span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a>
                <a href="https://onedrive.live.com/personal/fca2ac859c324518/_layouts/15/Doc.aspx?sourcedoc=%7B3498F185-D898-44D1-942D-DB81947347D7%7D&file=%E0%B8%9B%E0%B8%A3%E0%B8%B0%E0%B8%A1%E0%B8%B2%E0%B8%93%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B8%93%E0%B9%8C2568.xlsx&action=default&mobileredirect=true" target="_blank" rel="noopener noreferrer" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 themed-bg-700-hover border-l-4 border-transparent"><span class="w-6 mr-2 text-center">üìà</span> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Excel)</a>
            </nav>
            <!-- [NEW] Theme Switcher -->
            <div class="px-4 pt-4 mt-4 border-t border-slate-700">
                <p class="text-sm font-semibold text-white mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏µ‡∏°</p>
                <div class="flex space-x-2">
                    <button onclick="setTheme('slate')" class="w-6 h-6 rounded-full bg-slate-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent focus:ring-white"></button>
                    <button onclick="setTheme('sky')" class="w-6 h-6 rounded-full bg-sky-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent focus:ring-white"></button>
                    <button onclick="setTheme('emerald')" class="w-6 h-6 rounded-full bg-emerald-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent focus:ring-white"></button>
                </div>
            </div>
        </aside>
        
        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <div class="flex-1 lg:ml-64">
            <header class="bg-white shadow-sm sticky top-0 z-30">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center">
                    <button id="menu-btn" class="lg:hidden mr-4 p-2 rounded-md text-slate-500 hover:text-slate-800 hover:bg-slate-100" onclick="toggleSidebar()">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">My Life Dashboard - ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h1>
                        <p class="text-sm text-slate-500">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase</p>
                    </div>
                </div>
            </header>

            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="main-content-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <section id="overview" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üè†</span>
                            <h2 class="text-xl font-semibold text-gray-900">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                        </div>
                        <div id="overview-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-slate-400"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
                        </div>
                    </section>

                    <section id="website" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üåê</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                            </div>
                            <a href="https://jenprpa.github.io/TM/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                        </div>
                        <div class="w-full h-96 border border-slate-200 rounded-lg overflow-hidden">
                            <iframe src="https://jenprpa.github.io/TM/" class="w-full h-full" title="My Embedded Website"></iframe>
                        </div>
                    </section>

                    <section id="weekly-agenda" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div id="weekly-agenda-container">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-slate-400"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
                        </div>
                    </section>

                    <section id="okrs" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üöÄ</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (OKRs)</h2>
                            </div>
                            <button onclick="openOkrModal()" class="bg-blue-800 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-900 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Objective</button>
                        </div>
                        <div id="okrs-container" class="space-y-4">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="tasks" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üóÇÔ∏è</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h2>
                            </div>
                            <button onclick="openTaskModal()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-1" id="task-board">
                             <div class="text-center p-4 md:col-span-3"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="ideas" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üí°</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</h2>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="search" id="idea-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢..." class="px-2 py-1 border rounded-md text-sm">
                                <button onclick="openIdeaModal()" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-600 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
                            </div>
                        </div>
                        <div id="idea-board-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-1">
                             <div class="text-center p-4 md:col-span-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="planner" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                         <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">üìÖ</span>
                                    <h2 class="text-xl font-semibold text-gray-900">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
                                </div>
                                <button onclick="openScheduleModal(null, getToday())" class="bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-cyan-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                          </div>
                        <div id="calendar-container">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-slate-400"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô...</p></div>
                        </div>
                    </section>

                    <section id="habits" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üéØ</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</h2>
                            </div>
                            <button onclick="openHabitModal()" class="bg-teal-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-teal-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</button>
                        </div>
                        <div id="habit-tracker-container" class="max-h-96 overflow-y-auto p-1">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="health-tracker" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">‚ù§Ô∏è</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h2>
                            </div>
                             <button onclick="openHealthLogModal()" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="health-tracker-container" class="p-1">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="mood-tracker" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üòä</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                            </div>
                        </div>
                        <div id="mood-tracker-container">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="media-log" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üé¨</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡∏î‡∏π/‡∏ü‡∏±‡∏á</h2>
                            </div>
                            <button onclick="openMediaLogModal()" class="bg-gray-700 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-800 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                        </div>
                        <div id="media-log-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-1">
                             <div class="text-center p-4 md:col-span-3"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="event-log" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                         <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">üìå</span>
                                    <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h2>
                                </div>
                                <div class="flex items-center space-x-2">
                                  <input type="search" id="event-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå..." class="px-2 py-1 border rounded-md text-sm">
                                  <button onclick="openEventLogModal()" class="bg-orange-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-600 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</button>
                                </div>
                         </div>
                        <div id="event-log-container" class="space-y-3 max-h-96 overflow-y-auto">
                             <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="personal-growth" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üå±</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h2>
                            </div>
                            <button onclick="openPersonalGrowthModal()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
                        </div>
                        <div id="personal-growth-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto p-1">
                             <div class="text-center p-4 md:col-span-2"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>
                    
                    <section id="certificates" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üèÜ</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</h2>
                            </div>
                            <button onclick="openCertificateModal()" class="bg-amber-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-amber-600 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</button>
                        </div>
                        <div id="certificates-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-1">
                             <div class="text-center p-4 md:col-span-3"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="journal" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                         <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">üìì</span>
                                    <h2 class="text-xl font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
                                </div>
                                <button onclick="openJournalModal()" class="bg-purple-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-purple-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                         </div>
                        <div id="journal-entries" class="space-y-3 max-h-96 overflow-y-auto">
                           <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>
                    
                    <section id="knowledge" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                              <span class="text-2xl mr-3">üìö</span>
                              <h2 class="text-xl font-semibold text-gray-900">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</h2>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="search" id="knowledge-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ..." class="px-2 py-1 border rounded-md text-sm">
                                <button onclick="openKnowledgeModal()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</button>
                            </div>
                        </div>
                        <div id="knowledge-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                             <div class="text-center p-4 md:col-span-3"><i class="fas fa-spinner fa-spin text-slate-400"></i></div>
                        </div>
                    </section>

                    <section id="budget" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üí∞</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
                            </div>
                            <button onclick="openBudgetModal()" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-emerald-700 transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center">
                            <div class="bg-green-100 p-3 rounded-lg"><p class="text-sm text-green-800">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p id="total-income" class="text-xl font-bold text-green-600">‡∏ø0.00</p></div>
                            <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p id="total-expense" class="text-xl font-bold text-red-600">‡∏ø0.00</p></div>
                            <div class="bg-blue-100 p-3 rounded-lg"><p class="text-sm text-blue-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p id="balance" class="text-xl font-bold text-blue-600">‡∏ø0.00</p></div>
                        </div>
                        <div class="overflow-x-auto overflow-y-auto max-h-96">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-100 sticky top-0"><tr><th class="p-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-3"></th></tr></thead>
                                <tbody id="budget-table-body">
                                     <tr><td colspan="6" class="text-center p-4"><i class="fas fa-spinner fa-spin text-slate-400"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section id="finance-app" class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6 scroll-mt-20">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">üí∏</span>
                                <h2 class="text-xl font-semibold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                            </div>
                            <a href="https://jenprpa.github.io/budget/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                        </div>
                        <div class="w-full h-[600px] border border-slate-200 rounded-lg overflow-hidden">
                            <iframe src="https://jenprpa.github.io/budget/" class="w-full h-full" title="Personal Finance System"></iframe>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-container"></div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://aajlqfearyhlpwjcqjom.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhamxxZmVhcnlobHB3amNxam9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NjI0MzgsImV4cCI6MjA2OTUzODQzOH0.v9JRorJeSvGdAdZbvr1QHdAw9DaewpySUJ-ZiWr14nY';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE & CACHE ---
        let appState = {
            tasks: [],
            ideas: [],
            okrs: [],
            habits: [],
            habit_log: [],
            schedules: [],
            health_log: [],
            mood_logs: [],
            media_logs: [],
            event_log: [],
            personal_growth: [],
            certificates: [],
            journal_entries: [],
            knowledge_items: [],
            budget: [],
            filters: { // [NEW] For search functionality
                idea: '',
                event: '',
                knowledge: ''
            }
        };
        let currentViewDate = new Date();
        let weeklyAgendaDate = new Date();

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount || 0);
        const formatNumber = (amount) => new Intl.NumberFormat('th-TH').format(amount || 0);
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        const formatTime = (timeString) => {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }
        const getToday = () => new Date().toISOString().split('T')[0];
        const toYYYYMMDD = (date) => {
            if (!date) return null;
            const d = new Date(date);
            const y = d.getFullYear();
            const m = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${day}`;
        };
        const showToast = (message, type = 'success') => {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.id = toastId;
            toast.className = `fixed bottom-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg animate-bounce`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                const el = document.getElementById(toastId);
                if (el) el.remove();
            }, 5000); // Increased timeout for error messages
        };

        // --- MODAL & UI HANDLING ---
        const modalContainer = document.getElementById('modal-container');
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        const openConfirmModal = (title, message, onConfirm) => {
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h3 class="text-lg font-semibold mb-2">${title}</h3>
                        <p class="text-slate-600 mb-4">${message}</p>
                        <div class="flex justify-end space-x-2">
                            <button id="confirm-cancel-btn" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('confirm-ok-btn').onclick = () => {
                onConfirm();
                closeModal();
            };
            document.getElementById('confirm-cancel-btn').onclick = closeModal;
        };
        
        const toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        };

        // --- [NEW] THEME SWITCHER ---
        function setTheme(themeName) {
            const html = document.documentElement;
            html.classList.remove('theme-slate', 'theme-sky', 'theme-emerald');
            html.classList.add(`theme-${themeName}`);
            localStorage.setItem('dashboard-theme', themeName);
        }

        // --- GENERIC FORM HANDLER ---
        async function handleFormSubmit(e, tableName, onComplete, transformData = null) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            let data = Object.fromEntries(formData.entries());

            if (tableName === 'habits' && (!data.name || data.name.trim() === '')) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£', 'error');
                return;
            }

            const id = data.id;
            
            if (id === '' || id === 'null' || id === undefined) {
                delete data.id;
            }

            if (transformData) {
                data = transformData(data);
            }
            
            // Allow empty strings to be saved as null for non-required fields
            for (const key in data) {
                 if (key !== 'id' && data[key] === '') {
                     data[key] = null;
                 }
            }
            
            const { error } = id
                ? await db.from(tableName).update(data).eq('id', id)
                : await db.from(tableName).insert([data]);

            if (error) {
                console.error(`Error saving to ${tableName}:`, error);
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } else {
                showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                closeModal();
                if (onComplete) onComplete();
            }
        }

        // --- GENERIC DELETE ---
        function confirmDelete(tableName, id, onComplete) {
            openConfirmModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', async () => {
                const { error } = await db.from(tableName).delete().eq('id', id);
                if (error) {
                    console.error(`Error deleting from ${tableName}:`, error);
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                } else {
                    showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    if (onComplete) onComplete();
                }
            });
        }

        // --- TASK MANAGEMENT ---
        function openTaskModal(task = null) {
            const isEdit = task !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="task-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? task.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input name="title" type="text" value="${isEdit ? task.title : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label><input name="due_date" type="date" value="${isEdit ? toYYYYMMDD(task.due_date) : getToday()}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><select name="priority" class="w-full mt-1 p-2 border rounded-md"><option value="Low" ${isEdit && task.priority === 'Low' ? 'selected' : ''}>Low</option><option value="Medium" ${isEdit && task.priority === 'Medium' ? 'selected' : !isEdit ? 'selected' : ''}>Medium</option><option value="High" ${isEdit && task.priority === 'High' ? 'selected' : ''}>High</option></select></div>
                            <div><label class="text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select name="status" class="w-full mt-1 p-2 border rounded-md"><option value="To-Do" ${isEdit && task.status === 'To-Do' ? 'selected' : ''}>To-Do</option><option value="In Progress" ${isEdit && task.status === 'In Progress' ? 'selected' : ''}>In Progress</option><option value="Done" ${isEdit && task.status === 'Done' ? 'selected' : ''}>Done</option></select></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('task-form').addEventListener('submit', (e) => handleFormSubmit(e, 'tasks', fetchAllData));
        }
        async function fetchTasks() {
            const { data, error } = await db.from('tasks').select('*').order('due_date', { ascending: true, nullsFirst: false });
            if (error) { console.error('Error fetching tasks:', error); appState.tasks = []; return; }
            appState.tasks = data || [];
        }
        function renderTaskBoard() {
            const tasks = appState.tasks;
            const board = document.getElementById('task-board');
            if (!board) return;
            board.innerHTML = '';
            const statuses = ['To-Do', 'In Progress', 'Done'];
            statuses.forEach(status => {
                const column = document.createElement('div');
                column.className = 'bg-slate-100 rounded-lg p-3';
                const tasksInStatus = tasks.filter(t => t.status === status);
                let tasksHTML = tasksInStatus.map(task => `
                    <div class="bg-white p-3 rounded-md shadow-sm border border-slate-200 mb-2">
                        <div class="flex justify-between items-start">
                            <p class="font-semibold text-slate-800">${task.title}</p>
                            <button onclick='openTaskModal(${JSON.stringify(task)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatDate(task.due_date)}</div>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs font-medium px-2 py-1 rounded-full priority-${task.priority}">${task.priority}</span>
                            <button onclick="confirmDelete('tasks', ${task.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`).join('');
                column.innerHTML = `<h3 class="font-semibold text-slate-700 mb-3">${status} (${tasksInStatus.length})</h3><div class="space-y-2 min-h-[100px]">${tasksHTML || '<p class="text-xs text-slate-400 p-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</p>'}</div>`;
                board.appendChild(column);
            });
        }
        
        // --- BUDGET TRACKER ---
        function openBudgetModal(item = null) {
            const isEdit = item !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="budget-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? item.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input name="item" type="text" value="${isEdit ? item.item : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input name="amount" type="number" step="0.01" value="${isEdit ? item.amount : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="transaction_date" type="date" value="${isEdit ? toYYYYMMDD(item.transaction_date) : getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="transaction_type" class="w-full mt-1 p-2 border rounded-md"><option value="Income" ${isEdit && item.transaction_type === 'Income' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option><option value="Expense" ${isEdit && item.transaction_type === 'Expense' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option></select></div>
                            <div><label class="text-sm font-medium">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input name="category" type="text" value="${isEdit ? item.category : ''}" required class="w-full mt-1 p-2 border rounded-md" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á"></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('budget-form').addEventListener('submit', (e) => handleFormSubmit(e, 'budget', fetchAllData));
        }
        async function fetchBudget() {
            const { data, error } = await db.from('budget').select('*').order('transaction_date', { ascending: false });
            if (error) { console.error('Error fetching budget:', error); appState.budget = []; return; }
            appState.budget = data || [];
        }
        function renderBudget() {
            const items = appState.budget;
            const tableBody = document.getElementById('budget-table-body');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const balanceEl = document.getElementById('balance');
            if (!tableBody || !totalIncomeEl || !totalExpenseEl || !balanceEl) return;

            let totalIncome = 0;
            let totalExpense = 0;
            
            items.forEach(item => {
                if (item.transaction_type === 'Income') totalIncome += item.amount;
                else totalExpense += item.amount;
            });

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            balanceEl.textContent = formatCurrency(totalIncome - totalExpense);
            balanceEl.classList.toggle('text-red-600', totalIncome - totalExpense < 0);
            balanceEl.classList.toggle('text-blue-600', totalIncome - totalExpense >= 0);

            if (items.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                 return;
            }

            tableBody.innerHTML = items.map(item => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="p-3 font-medium">${item.item}</td>
                    <td class="p-3 ${item.transaction_type === 'Income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(item.amount)}</td>
                    <td class="p-3">${formatDate(item.transaction_date)}</td>
                    <td class="p-3"><span class="bg-slate-200 text-slate-700 px-2 py-1 text-xs rounded-full">${item.category}</span></td>
                    <td class="p-3">${item.transaction_type === 'Income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</td>
                    <td class="p-3 text-right">
                        <button onclick='openBudgetModal(${JSON.stringify(item)})' class="text-blue-500 hover:text-blue-700 p-1 text-sm">‚úèÔ∏è</button>
                        <button onclick="confirmDelete('budget', ${item.id}, fetchAllData)" class="text-red-500 hover:text-red-700 p-1 text-sm"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        // --- CALENDAR / PLANNER ---
        function openScheduleModal(item = null, date = null) {
            const isEdit = item !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="schedule-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? item.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input name="title" type="text" value="${isEdit ? item.title : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="event_date" type="date" value="${isEdit ? toYYYYMMDD(item.event_date) : date ? toYYYYMMDD(date) : getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input name="start_time" type="time" value="${isEdit && item.start_time ? item.start_time : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input name="end_time" type="time" value="${isEdit && item.end_time ? item.end_time : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea name="description" class="w-full mt-1 p-2 border rounded-md">${isEdit ? item.description || '' : ''}</textarea></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('schedule-form').addEventListener('submit', (e) => handleFormSubmit(e, 'schedules', fetchAllData));
        }
        async function fetchSchedules() {
            const { data, error } = await db.from('schedules').select('*');
            if (error) { console.error('Error fetching schedules:', error); appState.schedules = []; return; }
            appState.schedules = data || [];
        }
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            if(!container) return;
            
            const today = new Date();
            const month = currentViewDate.getMonth();
            const year = currentViewDate.getFullYear();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const dayNames = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];

            let header = `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-slate-100"><i class="fas fa-chevron-left"></i></button>
                    <h3 class="text-lg font-semibold">${monthNames[month]} ${year + 543}</h3>
                    <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-slate-100"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-slate-600">
                    ${dayNames.map(d => `<div>${d}</div>`).join('')}
                </div>`;

            let body = '<div class="grid grid-cols-7 gap-1 mt-2">';
            for (let i = 0; i < firstDay; i++) {
                body += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = toYYYYMMDD(date);
                const isToday = toYYYYMMDD(today) === dateStr;

                const daySchedules = appState.schedules.filter(s => toYYYYMMDD(s.event_date) === dateStr);
                const dayTasks = appState.tasks.filter(t => toYYYYMMDD(t.due_date) === dateStr);
                const dayExpenses = appState.budget.filter(i => toYYYYMMDD(i.transaction_date) === dateStr && i.transaction_type === 'Expense').reduce((sum, i) => sum + i.amount, 0);
                
                const dayMoodLog = appState.mood_logs.find(log => toYYYYMMDD(log.log_date) === dateStr);
                const moods = [
                    { mood: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', emoji: 'üòÅ' }, { mood: '‡∏î‡∏µ', emoji: 'üòä' },
                    { mood: '‡πÄ‡∏â‡∏¢‡πÜ', emoji: 'üòê' }, { mood: '‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ', emoji: 'üòü' },
                    { mood: '‡πÅ‡∏¢‡πà', emoji: 'üò†' }, { mood: '‡∏á‡πà‡∏ß‡∏á', emoji: 'üò¥' },
                    { mood: '‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢', emoji: 'ü§í' }, { mood: '‡∏ï‡∏Å‡πÉ‡∏à', emoji: 'üò±' }
                ];
                const dayMood = dayMoodLog ? moods.find(m => m.mood === dayMoodLog.mood) : null;

                body += `
                    <div class="calendar-day border border-slate-200 rounded-md p-2 h-28 flex flex-col cursor-pointer ${isToday ? 'today' : ''}" onclick="openDailyViewModal('${dateStr}')">
                        <div class="flex justify-between items-start">
                           <span class="font-bold">${day}</span>
                           ${dayMood ? `<span title="${dayMood.mood}">${dayMood.emoji}</span>` : ''}
                        </div>
                        <div class="text-xs mt-1 space-y-1 overflow-hidden">
                            ${daySchedules.length > 0 ? `<div class="flex items-center text-cyan-600" title="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"><i class="fa-solid fa-calendar-day w-4"></i> ${daySchedules.length}</div>` : ''}
                            ${dayTasks.length > 0 ? `<div class="flex items-center text-blue-600" title="‡∏á‡∏≤‡∏ô"><i class="fa-solid fa-check-square w-4"></i> ${dayTasks.length}</div>` : ''}
                            ${dayExpenses > 0 ? `<div class="flex items-center text-red-500" title="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢"><i class="fa-solid fa-coins w-4"></i> ${formatNumber(dayExpenses)}</div>` : ''}
                        </div>
                    </div>`;
            }
            body += '</div>';

            container.innerHTML = header + body;
        }
        function changeMonth(delta) {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            renderCalendar();
        }
        
        // --- OKRs ---
        function openOkrModal(okr = null) {
            const isEdit = okr !== null;
            const keyResults = isEdit && okr.key_results ? okr.key_results : [{ title: '', status: 'Not Started' }];
            let keyResultsHtml = keyResults.map((kr, index) => `
                <div class="flex items-center space-x-2" id="kr-row-${index}">
                    <input name="kr_title_${index}" type="text" value="${kr.title}" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å ${index + 1}" class="w-full p-2 border rounded-md">
                    <select name="kr_status_${index}" class="p-2 border rounded-md">
                        <option value="Not Started" ${kr.status === 'Not Started' ? 'selected' : ''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
                        <option value="In Progress" ${kr.status === 'In Progress' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                        <option value="Done" ${kr.status === 'Done' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>
                </div>
            `).join('');

            const tasksOptions = appState.tasks.map(t => `<option value="${t.id}" ${okr?.linked_task_ids?.includes(t.id) ? 'selected' : ''}>${t.title}</option>`).join('');
            const growthOptions = appState.personal_growth.map(g => `<option value="${g.id}" ${okr?.linked_growth_ids?.includes(g.id) ? 'selected' : ''}>${g.skill}</option>`).join('');

            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="okr-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Objective' : '‡πÄ‡∏û‡∏¥‡πà‡∏° Objective ‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? okr.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">Objective</label><input name="objective" type="text" value="${isEdit ? okr.objective : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</label><input name="quarter" type="text" value="${isEdit ? okr.quarter : ''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô Q3 2025" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="text-sm font-medium">Key Results</label>
                                <div id="key-results-container" class="space-y-2 mt-1">${keyResultsHtml}</div>
                                <button type="button" id="add-kr-btn" class="text-sm text-blue-600 mt-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Key Result</button>
                            </div>
                            <div>
                                <label class="text-sm font-medium">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
                                <select name="linked_task_ids" multiple class="w-full mt-1 p-2 border rounded-md h-24">${tasksOptions}</select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
                                <select name="linked_growth_ids" multiple class="w-full mt-1 p-2 border rounded-md h-24">${growthOptions}</select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-blue-800 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            
            let krIndex = keyResults.length;
            document.getElementById('add-kr-btn').onclick = () => {
                const container = document.getElementById('key-results-container');
                const newKr = document.createElement('div');
                newKr.className = 'flex items-center space-x-2';
                newKr.id = `kr-row-${krIndex}`;
                newKr.innerHTML = `
                    <input name="kr_title_${krIndex}" type="text" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å ${krIndex + 1}" class="w-full p-2 border rounded-md">
                    <select name="kr_status_${krIndex}" class="p-2 border rounded-md">
                        <option value="Not Started">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</option>
                        <option value="In Progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                        <option value="Done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    </select>`;
                container.appendChild(newKr);
                krIndex++;
            };

            const transformOkrData = (data) => {
                const key_results = [];
                for (let i = 0; i < krIndex; i++) {
                    const titleEl = document.querySelector(`[name="kr_title_${i}"]`);
                    if (titleEl && titleEl.value) {
                         key_results.push({
                            title: titleEl.value,
                            status: document.querySelector(`[name="kr_status_${i}"]`).value
                        });
                    }
                }
                data.key_results = key_results;
                
                const form = document.getElementById('okr-form');
                data.linked_task_ids = [...form.querySelectorAll('select[name="linked_task_ids"] option:checked')].map(opt => parseInt(opt.value));
                data.linked_growth_ids = [...form.querySelectorAll('select[name="linked_growth_ids"] option:checked')].map(opt => parseInt(opt.value));
                
                Object.keys(data).forEach(key => {
                    if (key.startsWith('kr_title_') || key.startsWith('kr_status_')) {
                        delete data[key];
                    }
                });

                return data;
            };

            document.getElementById('okr-form').addEventListener('submit', (e) => handleFormSubmit(e, 'okrs', fetchAllData, transformOkrData));
        }
        async function fetchOkrs() {
            const { data, error } = await db.from('okrs').select('*').order('quarter', { ascending: false });
            if (error) { console.error('Error fetching OKRs:', error); appState.okrs = []; return; }
            appState.okrs = data || [];
        }
        function renderOkrs() {
            const okrs = appState.okrs;
            const container = document.getElementById('okrs-container');
            if (!container) return;
            if (okrs.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>`;
                return;
            }
            container.innerHTML = okrs.map(okr => {
                const krs = okr.key_results || [];
                const doneCount = krs.filter(kr => kr.status === 'Done').length;
                const progress = krs.length > 0 ? (doneCount / krs.length) * 100 : 0;
                
                const linkedTasks = (okr.linked_task_ids || []).map(id => appState.tasks.find(t => t.id === id)).filter(Boolean);
                const linkedGrowth = (okr.linked_growth_ids || []).map(id => appState.personal_growth.find(g => g.id === id)).filter(Boolean);

                const linkedTasksHtml = linkedTasks.length > 0 ? `
                    <div class="mt-2">
                        <p class="text-xs font-semibold text-slate-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${linkedTasks.map(t => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${t.title}</span>`).join('')}
                        </div>
                    </div>` : '';
                
                const linkedGrowthHtml = linkedGrowth.length > 0 ? `
                    <div class="mt-2">
                        <p class="text-xs font-semibold text-slate-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á:</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${linkedGrowth.map(g => `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">${g.skill}</span>`).join('')}
                        </div>
                    </div>` : '';

                return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-blue-800">${okr.quarter}</p>
                            <h4 class="text-lg font-bold text-slate-800">${okr.objective}</h4>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button onclick='openOkrModal(${JSON.stringify(okr)})' class="text-blue-400 hover:text-blue-600 text-sm p-1">‚úèÔ∏è</button>
                             <button onclick="confirmDelete('okrs', ${okr.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-sm p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="progress-bar h-2 w-full">
                            <div class="progress-bar-inner h-2" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2">
                        ${krs.map(kr => `
                            <div class="flex items-center text-sm">
                                <i class="fa-solid ${kr.status === 'Done' ? 'fa-circle-check text-green-500' : kr.status === 'In Progress' ? 'fa-circle-half-stroke text-yellow-500' : 'fa-circle-notch text-slate-400'} mr-2"></i>
                                <span class="${kr.status === 'Done' ? 'line-through text-slate-500' : ''}">${kr.title}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${linkedTasksHtml}
                    ${linkedGrowthHtml}
                </div>
            `}).join('');
        }

        // --- IDEAS ---
        // [MODIFIED] Added fields for link and file upload
        function openIdeaModal(idea = null) {
            const isEdit = idea !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="idea-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? idea.id : ''}">
                        <input type="hidden" name="existing_file_url" value="${isEdit && idea.file_url ? idea.file_url : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</label><input name="title" type="text" value="${isEdit ? idea.title : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea name="description" class="w-full mt-1 p-2 border rounded-md h-24">${isEdit ? idea.description || '' : ''}</textarea></div>
                            <div><label class="text-sm font-medium">‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ)</label><input name="tags" type="text" value="${isEdit && idea.tags ? idea.tags.join(', ') : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label><input name="link_url" type="url" value="${isEdit ? idea.link_url || '' : ''}" class="w-full mt-1 p-2 border rounded-md" placeholder="https://..."></div>
                            <div>
                                <label class="text-sm font-medium">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û, PDF, PPT, DOC)</label>
                                <input name="file_upload" type="file" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                                ${isEdit && idea.file_url ? `<a href="${idea.file_url}" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 block">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ</a>` : ''}
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('idea-form').addEventListener('submit', handleIdeaSubmit);
        }

        // [NEW] Specific submit handler for ideas to manage file uploads
        async function handleIdeaSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const formData = new FormData(form);
            let data = Object.fromEntries(formData.entries());
            const file = data.file_upload;
            let fileUrl = data.existing_file_url || null;

            // 1. Handle file upload if a new file is provided
            if (file && file.size > 0) {
                const filePath = `public/${Date.now()}-${file.name}`;
                const { error: uploadError } = await db.storage.from('idea-files').upload(filePath, file);

                if (uploadError) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    console.error('Upload Error:', uploadError);
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    return;
                }
                const { data: urlData } = db.storage.from('idea-files').getPublicUrl(filePath);
                fileUrl = urlData.publicUrl;
            }

            // 2. Prepare data for the database
            const id = data.id;
            const dbData = {
                title: data.title,
                description: data.description || null,
                tags: data.tags ? data.tags.split(',').map(tag => tag.trim()).filter(Boolean) : null,
                link_url: data.link_url || null,
                file_url: fileUrl,
            };

            // 3. Upsert data into the 'ideas' table
            const { error } = id
                ? await db.from('ideas').update(dbData).eq('id', id)
                : await db.from('ideas').insert([dbData]);

            if (error) {
                console.error('Error saving idea:', error);
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                closeModal();
                fetchAllData();
            }
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        async function fetchIdeas() {
            const { data, error } = await db.from('ideas').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching ideas:', error); appState.ideas = []; return; }
            appState.ideas = data || [];
        }

        // [MODIFIED] Render links and files on the idea card
        function renderIdeaBoard() {
            const searchTerm = appState.filters.idea.toLowerCase();
            const ideas = appState.ideas.filter(idea => 
                idea.title.toLowerCase().includes(searchTerm) ||
                (idea.description && idea.description.toLowerCase().includes(searchTerm)) ||
                (idea.tags && idea.tags.join(' ').toLowerCase().includes(searchTerm))
            );
            const container = document.getElementById('idea-board-container');
            if (!container) return;
            if (ideas.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 md:col-span-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</p>`;
                return;
            }
            container.innerHTML = ideas.map(idea => `
                <div class="bg-yellow-100 p-3 rounded-lg shadow-sm h-full flex flex-col justify-between border border-yellow-200">
                    <div>
                        <h4 class="font-bold text-yellow-900">${idea.title}</h4>
                        <p class="text-sm text-yellow-800 mt-1 whitespace-pre-wrap">${idea.description || ''}</p>
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${(idea.tags || []).map(tag => `<span class="text-xs bg-yellow-300 text-yellow-900 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-yellow-200">
                        <div class="flex items-center space-x-3">
                            ${idea.link_url ? `<a href="${idea.link_url}" target="_blank" rel="noopener noreferrer" class="text-yellow-700 hover:text-yellow-900" title="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"><i class="fa-solid fa-link"></i></a>` : ''}
                            ${idea.file_url ? `<a href="${idea.file_url}" target="_blank" rel="noopener noreferrer" class="text-yellow-700 hover:text-yellow-900" title="‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö"><i class="fa-solid fa-paperclip"></i></a>` : ''}
                        </div>
                        <div class="text-right">
                            <button onclick='openIdeaModal(${JSON.stringify(idea)})' class="text-yellow-600 hover:text-yellow-800 text-xs p-1">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('ideas', ${idea.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- HABITS ---
        function openHabitModal(habit = null) {
            const isEdit = habit !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <form id="habit-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? habit.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</label><input name="name" type="text" value="${isEdit ? habit.name : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Font Awesome)</label><input name="icon" type="text" value="${isEdit && habit.icon ? habit.icon : ''}" class="w-full mt-1 p-2 border rounded-md" placeholder="‡πÄ‡∏ä‡πà‡∏ô fa-solid fa-book"></div>
                            <div><label class="text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                                <select name="frequency" id="frequency-select" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="daily" ${isEdit && habit.frequency === 'daily' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                    <option value="weekly" ${isEdit && habit.frequency === 'weekly' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                </select>
                            </div>
                            <div id="weekly-day-container" class="${!isEdit || habit.frequency !== 'weekly' ? 'hidden' : ''}">
                                <label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ (‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</label>
                                <select name="weekly_day" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="0" ${isEdit && habit.weekly_day === 0 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                                    <option value="1" ${isEdit && habit.weekly_day === 1 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                                    <option value="2" ${isEdit && habit.weekly_day === 2 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                                    <option value="3" ${isEdit && habit.weekly_day === 3 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option>
                                    <option value="4" ${isEdit && habit.weekly_day === 4 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                                    <option value="5" ${isEdit && habit.weekly_day === 5 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                                    <option value="6" ${isEdit && habit.weekly_day === 6 ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            
            const freqSelect = document.getElementById('frequency-select');
            const weeklyContainer = document.getElementById('weekly-day-container');
            freqSelect.onchange = () => {
                weeklyContainer.classList.toggle('hidden', freqSelect.value !== 'weekly');
            };

            document.getElementById('habit-form').addEventListener('submit', (e) => handleFormSubmit(e, 'habits', fetchAllData));
        }
        async function fetchHabits() {
            const todayStr = getToday();
            const [habitsRes, habitLogsRes] = await Promise.all([
                db.from('habits').select('*').order('sort_order'),
                db.from('habit_log').select('*')
            ]);
            if (habitsRes.error) { console.error('Error fetching habits:', habitsRes.error); appState.habits = []; }
            else { appState.habits = habitsRes.data || []; }

            if (habitLogsRes.error) { console.error('Error fetching habit_log:', habitLogsRes.error); appState.habit_log = []; }
            else { appState.habit_log = habitLogsRes.data || []; }
        }
        function renderHabitTracker() {
            const container = document.getElementById('habit-tracker-container');
            if (!container) return;

            const today = new Date();
            const dayOfWeek = today.getDay();

            const dailyHabits = appState.habits.filter(h => h.frequency === 'daily');
            const weeklyHabits = appState.habits.filter(h => h.frequency === 'weekly' && h.weekly_day === dayOfWeek);

            const renderList = (habits, listId) => {
                if (habits.length === 0) return '<p class="text-xs text-slate-400 p-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</p>';
                return `<div id="${listId}">${habits.map(habit => {
                    const isDone = appState.habit_log.some(log => log.habit_id === habit.id && log.completed_date === getToday());
                    return `
                    <div class="habit-item flex items-center justify-between bg-white p-3 rounded-md border border-slate-200 mb-2" draggable="true" data-id="${habit.id}">
                        <div class="flex items-center">
                            <i class="fas fa-grip-vertical drag-handle text-slate-400 mr-3"></i>
                            <input type="checkbox" id="habit-${habit.id}" class="habit-checkbox h-5 w-5 rounded text-teal-600 focus:ring-teal-500 border-gray-300 mr-3" ${isDone ? 'checked' : ''} onchange="logHabit(${habit.id}, this.checked)">
                            <label for="habit-${habit.id}" class="text-slate-800 flex items-center">
                                ${habit.icon ? `<i class="${habit.icon} w-5 text-center mr-2 text-teal-600"></i>` : ''}
                                <span class="font-medium">${habit.name}</span>
                            </label>
                        </div>
                        <div>
                            <button onclick='openHabitModal(${JSON.stringify(habit)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('habits', ${habit.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('')}</div>`;
            };

            container.innerHTML = `
                <div>
                    <h4 class="font-semibold text-slate-600 mb-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h4>
                    ${renderList(dailyHabits, 'daily-habit-list')}
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-slate-600 mb-2">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h4>
                    ${renderList(weeklyHabits, 'weekly-habit-list')}
                </div>
            `;
            
            const dailyList = document.getElementById('daily-habit-list');
            if(dailyList) addDragDropListeners(dailyList);
        }
        async function logHabit(habitId, isChecked) {
            const todayStr = getToday();
            if (isChecked) {
                const { error } = await db.from('habit_log').insert({ habit_id: habitId, completed_date: todayStr });
                if (error && error.code !== '23505') { 
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); console.error(error);
                } else { fetchAllData(); }
            } else {
                const { error } = await db.from('habit_log').delete().match({ habit_id: habitId, completed_date: todayStr });
                if (error) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); console.error(error);
                } else { fetchAllData(); }
            }
        }
        
        // --- HEALTH ---
        function openHealthLogModal(log = null) {
            const isEdit = log !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <form id="health-log-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? log.id : ''}">
                        <input type="hidden" name="log_date" value="${getToday()}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select name="type" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="food" ${isEdit && log.type === 'food' ? 'selected' : ''}>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                    <option value="exercise" ${isEdit && log.type === 'exercise' ? 'selected' : ''}>‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</option>
                                </select>
                            </div>
                            <div><label class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input name="item_name" type="text" value="${isEdit ? log.item_name : ''}" required class="w-full mt-1 p-2 border rounded-md" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà, ‡∏ß‡∏¥‡πà‡∏á 30 ‡∏ô‡∏≤‡∏ó‡∏µ"></div>
                            <div><label class="text-sm font-medium">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</label><input name="calories" type="number" value="${isEdit ? log.calories : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('health-log-form').addEventListener('submit', (e) => handleFormSubmit(e, 'health_log', fetchAllData));
        }
        async function fetchHealthLogs() {
            const { data, error } = await db.from('health_log').select('*');
            if (error) { console.error('Error fetching health_log:', error); appState.health_log = []; return; }
            appState.health_log = data || [];
        }
        function renderHealthTracker() {
            const container = document.getElementById('health-tracker-container');
            if (!container) return;
            
            const todayStr = getToday();
            const logsToday = appState.health_log.filter(log => log.log_date === todayStr);
            const foodLogs = logsToday.filter(log => log.type === 'food');
            const exerciseLogs = logsToday.filter(log => log.type === 'exercise');

            const caloriesIn = foodLogs.reduce((sum, log) => sum + log.calories, 0);
            const caloriesOut = exerciseLogs.reduce((sum, log) => sum + log.calories, 0);
            const calorieGoal = 1850;
            const remainingCalories = calorieGoal - (caloriesIn - caloriesOut);
            const progress = Math.min((caloriesIn / calorieGoal) * 100, 100);

            const renderLogList = (logs) => {
                if (logs.length === 0) return '<p class="text-sm text-slate-400 px-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                return logs.map(log => `
                    <div class="flex justify-between items-center text-sm py-1">
                        <span>${log.item_name}</span>
                        <span>${formatNumber(log.calories)} kcal</span>
                    </div>
                `).join('');
            };

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                    <div class="bg-green-100 p-3 rounded-lg"><p class="text-sm text-green-800">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (kcal)</p><p class="text-xl font-bold text-green-600">${formatNumber(caloriesIn)}</p></div>
                    <div class="bg-orange-100 p-3 rounded-lg"><p class="text-sm text-orange-800">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ (kcal)</p><p class="text-xl font-bold text-orange-600">${formatNumber(caloriesOut)}</p></div>
                    <div class="bg-blue-100 p-3 rounded-lg"><p class="text-sm text-blue-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (kcal)</p><p class="text-xl font-bold text-blue-600">${formatNumber(remainingCalories)}</p></div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${formatNumber(caloriesIn)} / ${formatNumber(calorieGoal)}</span>
                        <span>${Math.round(progress)}%</span>
                    </div>
                    <div class="progress-bar h-2 w-full">
                        <div class="progress-bar-inner h-2 bg-green-500" style="width: ${progress}%;"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô</h4>
                        <div class="space-y-1">${renderLogList(foodLogs)}</div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h4>
                        <div class="space-y-1">${renderLogList(exerciseLogs)}</div>
                    </div>
                </div>
            `;
        }

        // --- MOOD ---
        async function handleMoodSelect(mood) {
            const todayStr = getToday();
            const { data, error } = await db.from('mood_logs').upsert({ log_date: todayStr, mood: mood }, { onConflict: 'log_date' });
            if (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); console.error(error);
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!', 'success'); fetchAllData();
            }
        }
        async function fetchMoods() {
            const { data, error } = await db.from('mood_logs').select('*');
            if (error) { console.error('Error fetching mood_logs:', error); appState.mood_logs = []; return; }
            appState.mood_logs = data || [];
        }
        function renderMoodTracker() {
            const container = document.getElementById('mood-tracker-container');
            if (!container) return;
            const moods = [
                { mood: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', emoji: 'üòÅ' }, { mood: '‡∏î‡∏µ', emoji: 'üòä' },
                { mood: '‡πÄ‡∏â‡∏¢‡πÜ', emoji: 'üòê' }, { mood: '‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ', emoji: 'üòü' },
                { mood: '‡πÅ‡∏¢‡πà', emoji: 'üò†' }, { mood: '‡∏á‡πà‡∏ß‡∏á', emoji: 'üò¥' },
                { mood: '‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢', emoji: 'ü§í' }, { mood: '‡∏ï‡∏Å‡πÉ‡∏à', emoji: 'üò±' }
            ];
            const todayLog = appState.mood_logs.find(log => log.log_date === getToday());
            container.innerHTML = `
                <div class="flex justify-around items-center p-4 bg-slate-50 rounded-lg flex-wrap gap-2">
                    ${moods.map(m => `
                        <button class="mood-btn text-4xl p-2 rounded-full transition-transform duration-200 ${todayLog && todayLog.mood === m.mood ? 'selected' : ''}" 
                                title="${m.mood}" 
                                onclick="handleMoodSelect('${m.mood}')">
                            ${m.emoji}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // --- MEDIA LOG ---
        // [NEW] Handle submitting a new comment
        async function handleCommentSubmit(e, logId) {
            e.preventDefault();
            const form = e.target;
            const input = form.querySelector('input[name="comment"]');
            const commentText = input.value.trim();
            if (!commentText) return;

            const log = appState.media_logs.find(l => l.id === logId);
            if (!log) return;

            const existingComments = log.comments || [];
            const newComment = {
                text: commentText,
                timestamp: new Date().toISOString()
            };
            const updatedComments = [...existingComments, newComment];

            const { error } = await db.from('media_logs').update({ comments: updatedComments }).eq('id', logId);

            if (error) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ', 'error');
                console.error("Error adding comment:", error);
            } else {
                input.value = '';
                await fetchAllData();
                // Re-open the modal with updated comments
                const updatedLog = appState.media_logs.find(l => l.id === logId);
                openMediaLogCommentsModal(updatedLog);
            }
        }

        // [NEW] Modal for viewing and adding comments
        function openMediaLogCommentsModal(log) {
            const comments = log.comments || [];
            const commentsHtml = comments.length > 0
                ? comments.map(comment => `
                    <div class="bg-slate-100 p-2 rounded-md">
                        <p class="text-sm text-slate-800">${comment.text}</p>
                        <p class="text-xs text-slate-500 text-right mt-1">${formatDate(comment.timestamp)}</p>
                    </div>
                `).join('')
                : '<p class="text-sm text-slate-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>';

            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8 flex flex-col">
                        <div class="flex justify-between items-start">
                           <h3 class="text-lg font-semibold mb-4">‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <br><span class="font-normal">${log.title}</span></h3>
                           <button onclick="closeModal()" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
                        </div>
                        <div class="space-y-2 mb-4 flex-1 overflow-y-auto max-h-64 pr-2">${commentsHtml}</div>
                        <form id="comment-form">
                            <input name="comment" type="text" required class="w-full p-2 border rounded-md" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå...">
                            <button type="submit" class="w-full mt-2 px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800">‡∏™‡πà‡∏á</button>
                        </form>
                    </div>
                </div>`;
            document.getElementById('comment-form').addEventListener('submit', (e) => handleCommentSubmit(e, log.id));
        }

        function openMediaLogModal(log = null) {
            const isEdit = log !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="media-log-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? log.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input name="title" type="text" value="${isEdit ? log.title : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="type" class="w-full mt-1 p-2 border rounded-md"><option value="Book" ${isEdit && log.type === 'Book' ? 'selected' : ''}>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</option><option value="Movie" ${isEdit && log.type === 'Movie' ? 'selected' : ''}>‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</option><option value="Series" ${isEdit && log.type === 'Series' ? 'selected' : ''}>‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå</option><option value="Article" ${isEdit && log.type === 'Article' ? 'selected' : ''}>‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</option><option value="Podcast" ${isEdit && log.type === 'Podcast' ? 'selected' : ''}>‡∏û‡∏≠‡∏î‡πÅ‡∏Ñ‡∏™‡∏ï‡πå</option></select></div>
                            <div><label class="text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select name="status" class="w-full mt-1 p-2 border rounded-md"><option value="To Consume" ${isEdit && log.status === 'To Consume' ? 'selected' : ''}>‡∏à‡∏∞‡∏î‡∏π/‡∏≠‡πà‡∏≤‡∏ô</option><option value="Consuming" ${isEdit && log.status === 'Consuming' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π/‡∏≠‡πà‡∏≤‡∏ô</option><option value="Consumed" ${isEdit && log.status === 'Consumed' ? 'selected' : ''}>‡∏î‡∏π/‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option></select></div>
                            <div><label class="text-sm font-medium">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-5)</label><input name="rating" type="number" min="1" max="5" value="${isEdit ? log.rating : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-gray-700 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('media-log-form').addEventListener('submit', (e) => handleFormSubmit(e, 'media_logs', fetchAllData));
        }
        async function fetchMediaLogs() {
            const { data, error } = await db.from('media_logs').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching media_logs:', error); appState.media_logs = []; return; }
            appState.media_logs = data || [];
        }
        function renderMediaLog() {
            const logs = appState.media_logs;
            const container = document.getElementById('media-log-container');
            if (!container) return;
            if (logs.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 md:col-span-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>`;
                return;
            }
            const typeIcons = { Book: 'üìñ', Movie: 'üé¨', Series: 'üì∫', Article: 'üì∞', Podcast: 'üéôÔ∏è' };
            container.innerHTML = logs.map(log => {
                const commentCount = log.comments?.length || 0;
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                           <h4 class="font-bold text-slate-800">${log.title}</h4>
                           <span class="text-xl" title="${log.type}">${typeIcons[log.type] || '‚ùì'}</span>
                        </div>
                        <div class="text-sm text-slate-500 mt-2">
                            <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${log.status}</p>
                            ${log.rating ? `<p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${'‚≠ê'.repeat(log.rating)}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right mt-2 flex justify-end items-center space-x-2">
                        <button onclick='openMediaLogCommentsModal(${JSON.stringify(log)})' class="text-slate-500 hover:text-slate-700 text-xs p-1 flex items-center">
                           <i class="fa-solid fa-comments mr-1"></i> ${commentCount}
                        </button>
                        <button onclick='openMediaLogModal(${JSON.stringify(log)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                        <button onclick="confirmDelete('media_logs', ${log.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `}).join('');
        }

        // --- EVENT LOG ---
        async function handleEventLogSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const formData = new FormData(form);
            let data = Object.fromEntries(formData.entries());
            const imageFile = data.image_upload;
            let imageUrl = data.existing_image_url || null;

            if (imageFile && imageFile.size > 0) {
                const filePath = `public/${Date.now()}-${imageFile.name}`;
                const { error: uploadError } = await db.storage.from('event-images').upload(filePath, imageFile);

                if (uploadError) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    console.error('Upload Error:', uploadError);
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    return;
                }
                const { data: urlData } = db.storage.from('event-images').getPublicUrl(filePath);
                imageUrl = urlData.publicUrl;
            }

            const id = data.id;
            const dbData = {
                description: data.description,
                event_date: data.event_date,
                event_time: data.event_time || null,
                image_url: imageUrl,
            };

            const { error } = id
                ? await db.from('event_log').update(dbData).eq('id', id)
                : await db.from('event_log').insert([dbData]);

            if (error) {
                console.error('Error saving event log:', error);
                if (error.code === 'PGRST204' && error.message.includes('image_url')) {
                     showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "image_url" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á event_log ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Supabase', 'error');
                } else {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                }
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                closeModal();
                fetchAllData();
            }
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        function openEventLogModal(log = null) {
            const isEdit = log !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="event-log-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? log.id : ''}">
                        <input type="hidden" name="existing_image_url" value="${isEdit && log.image_url ? log.image_url : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</label><textarea name="description" required class="w-full mt-1 p-2 border rounded-md">${isEdit ? log.description : ''}</textarea></div>
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="event_date" type="date" value="${isEdit ? toYYYYMMDD(log.event_date) : getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÄ‡∏ß‡∏•‡∏≤</label><input name="event_time" type="time" value="${isEdit && log.event_time ? log.event_time : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="text-sm font-medium">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                                <input name="image_upload" type="file" accept="image/*" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                ${isEdit && log.image_url ? `<img src="${log.image_url}" alt="Preview" class="mt-2 rounded-md max-h-40 w-auto">` : ''}
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('event-log-form').addEventListener('submit', handleEventLogSubmit);
        }

        async function fetchEventLogs() {
            const { data, error } = await db.from('event_log').select('*').order('event_date', { ascending: false }).order('event_time', { ascending: false });
            if (error) { console.error('Error fetching event_log:', error); appState.event_log = []; return; }
            appState.event_log = data || [];
        }

        function renderEventLog() {
            const searchTerm = appState.filters.event.toLowerCase();
            const logs = appState.event_log.filter(log => 
                log.description.toLowerCase().includes(searchTerm)
            );
            const container = document.getElementById('event-log-container');
            if (!container) return;
            if (logs.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>`;
                return;
            }
            container.innerHTML = logs.map(log => `
                <div class="bg-white p-3 rounded-md border border-slate-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 pr-4">
                            <p><span class="font-semibold text-orange-600">${formatDate(log.event_date)} ${log.event_time ? formatTime(log.event_time) : ''}:</span></p>
                            <p class="mt-1 whitespace-pre-wrap">${log.description}</p>
                            ${log.image_url ? `<a href="${log.image_url}" target="_blank"><img src="${log.image_url}" alt="Event image" class="mt-2 rounded-lg max-h-48 w-auto shadow-sm"></a>` : ''}
                        </div>
                        <div class="flex-shrink-0">
                            <button onclick='openEventLogModal(${JSON.stringify(log)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('event_log', ${log.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }


        // --- PERSONAL GROWTH ---
        async function handlePersonalGrowthSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const formData = new FormData(form);
            let data = Object.fromEntries(formData.entries());
            const file = data.file_upload;
            let fileUrl = data.existing_file_url || null;

            if (file && file.size > 0) {
                const filePath = `public/${Date.now()}-${file.name}`;
                const { error: uploadError } = await db.storage.from('personal-growth-files').upload(filePath, file);

                if (uploadError) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    console.error('Upload Error:', uploadError);
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    return;
                }
                const { data: urlData } = db.storage.from('personal-growth-files').getPublicUrl(filePath);
                fileUrl = urlData.publicUrl;
            }

            const tasks = [];
            const formElements = form.elements;
            for(let i=0; i < formElements.length; i++) {
                const el = formElements[i];
                if (el.name && el.name.startsWith('pg_task_title_')) {
                    const index = el.name.split('_')[3];
                    const title = el.value;
                    const completedEl = document.querySelector(`[name="pg_task_completed_${index}"]`);
                    if (title && completedEl) {
                        tasks.push({ title, completed: completedEl.checked });
                    }
                }
            }

            const id = data.id;
            const dbData = {
                skill: data.skill,
                resource_link: data.resource_link,
                status: data.status,
                tasks: tasks,
                file_url: fileUrl,
            };

            const { error } = id
                ? await db.from('personal_growth').update(dbData).eq('id', id)
                : await db.from('personal_growth').insert([dbData]);

            if (error) {
                console.error('Error saving personal growth item:', error);
                if (error.code === 'PGRST204' && error.message.includes('file_url')) {
                     showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "file_url" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á personal_growth ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Supabase', 'error');
                } else {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                }
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                closeModal();
                fetchAllData();
            }
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        function openPersonalGrowthModal(item = null) {
            const isEdit = item !== null;
            const tasks = isEdit && item.tasks ? item.tasks : [{ title: '', completed: false }];
            let tasksHtml = tasks.map((task, index) => `
                <div class="flex items-center space-x-2" id="pg-task-row-${index}">
                    <input name="pg_task_completed_${index}" type="checkbox" ${task.completed ? 'checked' : ''} class="h-5 w-5 rounded text-green-500">
                    <input name="pg_task_title_${index}" type="text" value="${task.title}" placeholder="‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ ${index + 1}" class="w-full p-2 border rounded-md">
                    <button type="button" onclick="document.getElementById('pg-task-row-${index}').remove()" class="text-red-500 hover:text-red-700">&times;</button>
                </div>
            `).join('');

            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="growth-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? item.id : ''}">
                        <input type="hidden" name="existing_file_url" value="${isEdit && item.file_url ? item.file_url : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ó‡∏±‡∏Å‡∏©‡∏∞/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label><input name="skill" type="text" value="${isEdit ? item.skill : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏¥‡∏á‡∏Å‡πå)</label><input name="resource_link" type="url" value="${isEdit ? item.resource_link || '' : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                <select name="status" id="pg-status-select" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="To Learn" ${isEdit && item.status === 'To Learn' ? 'selected' : ''}>‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option>
                                    <option value="Learning" ${isEdit && item.status === 'Learning' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option>
                                    <option value="Learned" ${isEdit && item.status === 'Learned' ? 'selected' : ''}>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß</option>
                                </select>
                            </div>
                            <div id="pg-file-upload-container" class="${!isEdit || item.status !== 'Learning' ? 'hidden' : ''}">
                                <label class="text-sm font-medium">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/PDF)</label>
                                <input name="file_upload" type="file" accept="image/*,application/pdf" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                ${isEdit && item.file_url ? `<a href="${item.file_url}" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 block">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ</a>` : ''}
                            </div>
                            <div>
                                <label class="text-sm font-medium">Goal Tasks</label>
                                <div id="pg-tasks-container" class="space-y-2 mt-1">${tasksHtml}</div>
                                <button type="button" id="add-pg-task-btn" class="text-sm text-blue-600 mt-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Task</button>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            
            let taskIndex = tasks.length;
            document.getElementById('add-pg-task-btn').onclick = () => {
                const container = document.getElementById('pg-tasks-container');
                const newRow = document.createElement('div');
                newRow.className = 'flex items-center space-x-2';
                newRow.id = `pg-task-row-${taskIndex}`;
                newRow.innerHTML = `
                    <input name="pg_task_completed_${taskIndex}" type="checkbox" class="h-5 w-5 rounded text-green-500">
                    <input name="pg_task_title_${taskIndex}" type="text" placeholder="‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ ${taskIndex + 1}" class="w-full p-2 border rounded-md">
                    <button type="button" onclick="document.getElementById('pg-task-row-${taskIndex}').remove()" class="text-red-500 hover:text-red-700">&times;</button>
                `;
                container.appendChild(newRow);
                taskIndex++;
            };

            const statusSelect = document.getElementById('pg-status-select');
            const fileUploadContainer = document.getElementById('pg-file-upload-container');
            statusSelect.addEventListener('change', () => {
                if (statusSelect.value === 'Learning') {
                    fileUploadContainer.classList.remove('hidden');
                } else {
                    fileUploadContainer.classList.add('hidden');
                }
            });

            document.getElementById('growth-form').addEventListener('submit', handlePersonalGrowthSubmit);
        }

        async function fetchPersonalGrowthItems() {
            const { data, error } = await db.from('personal_growth').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching personal_growth:', error); appState.personal_growth = []; return; }
            appState.personal_growth = data || [];
        }
        
        function renderPersonalGrowth() {
            const items = appState.personal_growth;
            const container = document.getElementById('personal-growth-container');
            if (!container) return;
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 md:col-span-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>`;
                return;
            }
            container.innerHTML = items.map(item => {
                const tasks = item.tasks || [];
                const completedCount = tasks.filter(t => t.completed).length;
                const progress = tasks.length > 0 ? (completedCount / tasks.length) * 100 : 0;
                const fileHtml = item.file_url
                    ? `<a href="${item.file_url}" target="_blank" class="flex items-center text-sm text-blue-600 hover:underline mt-2">
                         <i class="fa-solid fa-paperclip mr-2"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                        </a>`
                    : '';

                return `
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-green-800">${item.skill}</h4>
                            <p class="text-sm text-green-700 mt-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${item.status}</p>
                            ${item.resource_link ? `<a href="${item.resource_link}" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 block">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>` : ''}
                            ${fileHtml}
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick='openPersonalGrowthModal(${JSON.stringify(item)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('personal_growth', ${item.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                     <div class="mt-3">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="progress-bar h-2 w-full">
                            <div class="progress-bar-inner h-2 bg-green-500" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1">
                        ${tasks.map(task => `
                            <div class="flex items-center text-sm">
                                <i class="fa-solid ${task.completed ? 'fa-circle-check text-green-500' : 'fa-circle-notch text-slate-400'} mr-2"></i>
                                <span class="${task.completed ? 'line-through text-slate-500' : ''}">${task.title}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `}).join('');
        }
        
        // --- [NEW] CERTIFICATES ---
        async function handleCertificateSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const formData = new FormData(form);
            let data = Object.fromEntries(formData.entries());
            const file = data.file_upload;
            let fileUrl = data.existing_file_url || null;

            if (!file && !fileUrl) {
                 showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£', 'error');
                 submitButton.disabled = false;
                 submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                 return;
            }

            if (file && file.size > 0) {
                const filePath = `public/${Date.now()}-${file.name}`;
                const { error: uploadError } = await db.storage.from('certificates').upload(filePath, file);

                if (uploadError) {
                    showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    console.error('Upload Error:', uploadError);
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    return;
                }
                const { data: urlData } = db.storage.from('certificates').getPublicUrl(filePath);
                fileUrl = urlData.publicUrl;
            }

            const id = data.id;
            const dbData = {
                title: data.title,
                issuer: data.issuer,
                issue_date: data.issue_date,
                file_url: fileUrl,
            };

            const { error } = id
                ? await db.from('certificates').update(dbData).eq('id', id)
                : await db.from('certificates').insert([dbData]);

            if (error) {
                console.error('Error saving certificate:', error);
                if (error.code === 'PGRST204') {
                     showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á certificates ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Supabase', 'error');
                } else {
                    showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                }
            } else {
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                closeModal();
                fetchAllData();
            }
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        function openCertificateModal(item = null) {
            const isEdit = item !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="certificate-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? item.id : ''}">
                        <input type="hidden" name="existing_file_url" value="${isEdit && item.file_url ? item.file_url : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</label><input name="title" type="text" value="${isEdit ? item.title : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ</label><input name="issuer" type="text" value="${isEdit ? item.issuer : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ</label><input name="issue_date" type="date" value="${isEdit ? toYYYYMMDD(item.issue_date) : getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="text-sm font-medium">‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/PDF)</label>
                                <input name="file_upload" type="file" accept="image/*,application/pdf" class="w-full text-sm mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100" ${!isEdit ? 'required' : ''}>
                                ${isEdit && item.file_url ? `<a href="${item.file_url}" target="_blank" class="text-sm text-blue-600 hover:underline mt-1 block">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ</a>` : ''}
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-amber-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('certificate-form').addEventListener('submit', handleCertificateSubmit);
        }

        async function fetchCertificates() {
            const { data, error } = await db.from('certificates').select('*').order('issue_date', { ascending: false });
            if (error) { console.error('Error fetching certificates:', error); appState.certificates = []; return; }
            appState.certificates = data || [];
        }

        function renderCertificates() {
            const items = appState.certificates;
            const container = document.getElementById('certificates-container');
            if (!container) return;
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 md:col-span-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</p>`;
                return;
            }
            container.innerHTML = items.map(item => {
                const isImage = item.file_url && /\.(jpg|jpeg|png|gif)$/i.test(item.file_url);
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex flex-col justify-between">
                    <div>
                        <a href="${item.file_url}" target="_blank">
                            ${isImage 
                                ? `<img src="${item.file_url}" alt="${item.title}" class="w-full h-40 object-cover rounded-md mb-2 bg-slate-100">` 
                                : `<div class="w-full h-40 rounded-md mb-2 bg-slate-100 flex items-center justify-center text-slate-400"><i class="fa-solid fa-file-pdf fa-3x"></i></div>`
                            }
                        </a>
                        <h4 class="font-bold text-slate-800">${item.title}</h4>
                        <p class="text-sm text-slate-600 mt-1">‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢: ${item.issuer}</p>
                        <p class="text-xs text-slate-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(item.issue_date)}</p>
                    </div>
                    <div class="text-right mt-2">
                        <button onclick='openCertificateModal(${JSON.stringify(item)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                        <button onclick="confirmDelete('certificates', ${item.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `}).join('');
        }


        // --- JOURNAL ---
        function openJournalModal(entry = null) {
            const isEdit = entry !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <form id="journal-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? entry.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input name="entry_date" type="date" value="${isEdit ? toYYYYMMDD(entry.entry_date) : getToday()}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì</label><textarea name="gratitude" class="w-full mt-1 p-2 border rounded-md h-20">${isEdit ? entry.gratitude || '' : ''}</textarea></div>
                            <div><label class="text-sm font-medium">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô</label><textarea name="small_wins" class="w-full mt-1 p-2 border rounded-md h-20">${isEdit ? entry.small_wins || '' : ''}</textarea></div>
                            <div><label class="text-sm font-medium">‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</label><textarea name="mood_check_in" class="w-full mt-1 p-2 border rounded-md h-20">${isEdit ? entry.mood_check_in || '' : ''}</textarea></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('journal-form').addEventListener('submit', (e) => handleFormSubmit(e, 'journal_entries', fetchAllData));
        }
        async function fetchJournalEntries() {
            const { data, error } = await db.from('journal_entries').select('*').order('entry_date', { ascending: false });
            if (error) { console.error('Error fetching journal_entries:', error); appState.journal_entries = []; return; }
            appState.journal_entries = data || [];
        }
        function renderJournalEntries() {
            const entries = appState.journal_entries;
            const container = document.getElementById('journal-entries');
            if (!container) return;
            if (entries.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>`;
                return;
            }
            container.innerHTML = entries.map(entry => `
                <div class="bg-white p-4 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold text-purple-700">${formatDate(entry.entry_date)}</p>
                        <div>
                            <button onclick='openJournalModal(${JSON.stringify(entry)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('journal_entries', ${entry.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    ${entry.gratitude ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì:</strong><p class="text-slate-700 whitespace-pre-wrap">${entry.gratitude}</p></div>` : ''}
                    ${entry.small_wins ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:</strong><p class="text-slate-700 whitespace-pre-wrap">${entry.small_wins}</p></div>` : ''}
                    ${entry.mood_check_in ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå:</strong><p class="text-slate-700 whitespace-pre-wrap">${entry.mood_check_in}</p></div>` : ''}
                </div>
            `).join('');
        }
        
        // --- KNOWLEDGE ---
        function openKnowledgeModal(item = null) {
            const isEdit = item !== null;
            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <form id="knowledge-form" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md my-8">
                        <h3 class="text-lg font-semibold mb-4">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà'}</h3>
                        <input type="hidden" name="id" value="${isEdit ? item.id : ''}">
                        <div class="space-y-4">
                            <div><label class="text-sm font-medium">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input name="topic" type="text" value="${isEdit ? item.topic : ''}" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡∏™‡∏£‡∏∏‡∏õ</label><textarea name="summary" class="w-full mt-1 p-2 border rounded-md h-24">${isEdit ? item.summary || '' : ''}</textarea></div>
                             <div><label class="text-sm font-medium">‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ)</label><input name="tags" type="text" value="${isEdit && item.tags ? item.tags.join(', ') : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="text-sm font-medium">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤ (URL)</label><input name="url" type="url" value="${isEdit ? item.url : ''}" class="w-full mt-1 p-2 border rounded-md"></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>`;
                 const transformKnowledgeData = (data) => {
                     if (data.tags) { data.tags = data.tags.split(',').map(tag => tag.trim()).filter(Boolean); }
                     return data;
                 };
            document.getElementById('knowledge-form').addEventListener('submit', (e) => handleFormSubmit(e, 'knowledge_base', fetchAllData, transformKnowledgeData));
        }
        async function fetchKnowledgeItems() {
            const { data, error } = await db.from('knowledge_base').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Error fetching knowledge_base:', error); appState.knowledge_items = []; return; }
            appState.knowledge_items = data || [];
        }
        function renderKnowledgeGallery() {
            const searchTerm = appState.filters.knowledge.toLowerCase();
            const items = appState.knowledge_items.filter(item => 
                item.topic.toLowerCase().includes(searchTerm) ||
                (item.summary && item.summary.toLowerCase().includes(searchTerm)) ||
                (item.tags && item.tags.join(' ').toLowerCase().includes(searchTerm))
            );
            const container = document.getElementById('knowledge-gallery');
            if (!container) return;
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 md:col-span-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                    <h4 class="font-bold text-indigo-800">${item.topic}</h4>
                    <p class="text-sm text-indigo-700 mt-1">${item.summary || ''}</p>
                    <div class="mt-2 flex flex-wrap gap-1">
                        ${(item.tags || []).map(tag => `<span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                    </div>
                    ${item.url ? `<a href="${item.url}" target="_blank" class="text-sm text-blue-600 hover:underline mt-2 block">‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>` : ''}
                    <div class="text-right mt-2">
                        <button onclick='openKnowledgeModal(${JSON.stringify(item)})' class="text-blue-400 hover:text-blue-600 text-xs p-1">‚úèÔ∏è</button>
                        <button onclick="confirmDelete('knowledge_base', ${item.id}, fetchAllData)" class="text-red-400 hover:text-red-600 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- WEEKLY AGENDA ---
        function renderWeeklyAgenda() {
            const container = document.getElementById('weekly-agenda-container');
            if (!container) return;

            const startOfWeek = new Date(weeklyAgendaDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            
            let content = `<div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">üóìÔ∏è</span>
                    <h2 class="text-xl font-semibold text-gray-900">‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="changeWeek(-1)" class="p-2 rounded-full hover:bg-slate-100 text-sm"><i class="fas fa-chevron-left"></i></button>
                    <span class="text-sm font-medium">${formatDate(startOfWeek)} - ${formatDate(new Date(new Date(startOfWeek).setDate(startOfWeek.getDate() + 6)))}</span>
                    <button onclick="changeWeek(1)" class="p-2 rounded-full hover:bg-slate-100 text-sm"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>`;

            content += '<div class="grid grid-cols-1 md:grid-cols-7 gap-2">';
            const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(day.getDate() + i);
                const dateStr = toYYYYMMDD(day);
                
                const daySchedules = appState.schedules.filter(s => toYYYYMMDD(s.event_date) === dateStr);
                const dayTasks = appState.tasks.filter(t => toYYYYMMDD(t.due_date) === dateStr);

                let itemsHtml = daySchedules.map(s => `<div class="text-xs p-1.5 bg-cyan-100 text-cyan-800 rounded" title="${s.title}">${s.start_time ? `<b>${formatTime(s.start_time)}</b> ` : ''}${s.title}</div>`).join('');
                itemsHtml += dayTasks.map(t => `<div class="text-xs p-1.5 ${t.status === 'Done' ? 'bg-green-100 text-green-800 line-through' : 'bg-blue-100 text-blue-800'} rounded" title="${t.title}">${t.title}</div>`).join('');

                content += `
                    <div class="bg-slate-50 rounded-lg p-2 min-h-[120px]">
                        <p class="font-bold text-sm">${dayNames[i]}</p>
                        <p class="text-xs text-slate-500 mb-2">${day.getDate()}</p>
                        <div class="space-y-1">${itemsHtml || '<p class="text-xs text-slate-400 p-2 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô</p>'}</div>
                    </div>`;
            }
            content += '</div>';
            container.innerHTML = content;
        }

        function changeWeek(delta) {
            weeklyAgendaDate.setDate(weeklyAgendaDate.getDate() + (delta * 7));
            renderWeeklyAgenda();
        }

        // --- OVERVIEW ---
        function renderDashboardOverview() {
            const container = document.getElementById('overview-container');
            if (!container) return;
            
            const todayStr = getToday();
            const today = new Date();
            const dayOfWeek = today.getDay();

            const tasksToday = appState.tasks.filter(t => toYYYYMMDD(t.due_date) === todayStr && t.status !== 'Done').length;
            const eventsToday = appState.schedules.filter(s => toYYYYMMDD(s.event_date) === todayStr).length;
            const habitsDoneToday = appState.habit_log.filter(hl => toYYYYMMDD(hl.completed_date) === todayStr).length;
            
            const totalApplicableHabits = appState.habits.filter(h => h.frequency === 'daily' || (h.frequency === 'weekly' && h.weekly_day === dayOfWeek)).length;
            
            container.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                    <p class="text-sm text-blue-700">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p class="text-3xl font-bold text-blue-800">${tasksToday}</p>
                </div>
                <div class="bg-cyan-50 border border-cyan-200 p-4 rounded-lg text-center">
                    <p class="text-sm text-cyan-700">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p class="text-3xl font-bold text-cyan-800">${eventsToday}</p>
                </div>
                <div class="bg-teal-50 border border-teal-200 p-4 rounded-lg text-center">
                    <p class="text-sm text-teal-700">‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p class="text-3xl font-bold text-teal-800">${habitsDoneToday} / ${totalApplicableHabits}</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                    <p class="text-sm text-yellow-700">‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p class="text-3xl font-bold text-yellow-800">${appState.ideas.length}</p>
                </div>
            `;
        }

        // --- DAILY VIEW MODAL ---
        function openDailyViewModal(dateStr) {
             const daySchedules = appState.schedules.filter(s => toYYYYMMDD(s.event_date) === dateStr);
             const dayTasks = appState.tasks.filter(t => toYYYYMMDD(t.due_date) === dateStr);
             const dayJournal = appState.journal_entries.find(j => toYYYYMMDD(j.entry_date) === dateStr);
             const dayOfWeek = new Date(dateStr).getDay();
             const dailyHabitsForDay = appState.habits.filter(h => h.frequency === 'daily');
             const weeklyHabitsForDay = appState.habits.filter(h => h.frequency === 'weekly' && h.weekly_day === dayOfWeek);
             const allHabitsForDay = [...dailyHabitsForDay, ...weeklyHabitsForDay];
             const dayExpensesList = appState.budget.filter(i => toYYYYMMDD(i.transaction_date) === dateStr && i.transaction_type === 'Expense');
             const completedHabitsForDay = appState.habit_log.filter(log => log.completed_date === dateStr);
             const habitProgress = allHabitsForDay.length > 0 ? (completedHabitsForDay.length / allHabitsForDay.length) * 100 : 0;

            const dayMoodLog = appState.mood_logs.find(log => toYYYYMMDD(log.log_date) === dateStr);
            const moods = [
                { mood: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', emoji: 'üòÅ' }, { mood: '‡∏î‡∏µ', emoji: 'üòä' },
                { mood: '‡πÄ‡∏â‡∏¢‡πÜ', emoji: 'üòê' }, { mood: '‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ', emoji: 'üòü' },
                { mood: '‡πÅ‡∏¢‡πà', emoji: 'üò†' }, { mood: '‡∏á‡πà‡∏ß‡∏á', emoji: 'üò¥' },
                { mood: '‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢', emoji: 'ü§í' }, { mood: '‡∏ï‡∏Å‡πÉ‡∏à', emoji: 'üò±' }
            ];
            const dayMood = dayMoodLog ? moods.find(m => m.mood === dayMoodLog.mood) : null;


             let scheduleHtml = daySchedules.length > 0 ? daySchedules.map(s => `<div class="text-sm p-2 bg-cyan-50 rounded">${s.start_time ? `<b>${formatTime(s.start_time)}</b> ` : ''}${s.title}</div>`).join('') : '<p class="text-sm text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>';
             let taskHtml = dayTasks.length > 0 ? dayTasks.map(t => `<div class="text-sm p-2 bg-blue-50 rounded ${t.status === 'Done' ? 'line-through' : ''}">${t.title}</div>`).join('') : '<p class="text-sm text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</p>';
             let expenseHtml = dayExpensesList.length > 0 ? dayExpensesList.map(item => `<div class="text-sm p-2 bg-red-50 rounded flex justify-between"><span>${item.item}</span> <span>${formatCurrency(item.amount)}</span></div>`).join('') : '<p class="text-sm text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>';
             let journalHtml = dayJournal ? `
                 ${dayJournal.gratitude ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì:</strong><p class="text-slate-700 whitespace-pre-wrap">${dayJournal.gratitude}</p></div>` : ''}
                 ${dayJournal.small_wins ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:</strong><p class="text-slate-700 whitespace-pre-wrap">${dayJournal.small_wins}</p></div>` : ''}
                 ${dayJournal.mood_check_in ? `<div class="mt-2"><strong class="text-sm text-slate-600">‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå:</strong><p class="text-slate-700 whitespace-pre-wrap">${dayJournal.mood_check_in}</p></div>` : ''}
             ` : '<p class="text-sm text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
            let habitSummaryHtml = `
                <div class="flex justify-between items-center text-sm mb-1">
                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</span>
                    <span>${completedHabitsForDay.length}/${allHabitsForDay.length} (${Math.round(habitProgress)}%)</span>
                </div>
                <div class="progress-bar h-2 w-full">
                    <div class="progress-bar-inner h-2 bg-teal-500" style="width: ${habitProgress}%;"></div>
                </div>
            `;
            let moodHtml = dayMood ? `<div class="text-sm p-2 bg-yellow-50 rounded flex items-center"><span class="text-2xl mr-2">${dayMood.emoji}</span> ${dayMood.mood}</div>` : '<p class="text-sm text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</p>';

            modalContainer.innerHTML = `
                <div class="modal is-open fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl my-8 relative">
                         <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                         <h3 class="text-xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(dateStr)}</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto p-2">
                              <div>
                                  <h4 class="font-semibold mb-2">üóìÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h4>
                                  <div class="space-y-2">${scheduleHtml}</div>
                              </div>
                             <div>
                                  <h4 class="font-semibold mb-2">üóÇÔ∏è ‡∏á‡∏≤‡∏ô</h4>
                                  <div class="space-y-2">${taskHtml}</div>
                              </div>
                              <div class="md:col-span-2">
                                  <h4 class="font-semibold mb-2">üéØ ‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£</h4>
                                  <div class="space-y-2">${habitSummaryHtml}</div>
                              </div>
                             <div class="md:col-span-2">
                                  <h4 class="font-semibold mb-2">üòä ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</h4>
                                  <div class="space-y-2">${moodHtml}</div>
                              </div>
                             <div class="md:col-span-2">
                                  <h4 class="font-semibold mb-2">üí∞ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h4>
                                  <div class="space-y-2">${expenseHtml}</div>
                              </div>
                              <div class="md:col-span-2">
                                  <h4 class="font-semibold mb-2">‚ù§Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h4>
                                  <div id="daily-health-view"></div>
                              </div>
                              <div class="md:col-span-2">
                                  <h4 class="font-semibold mb-2">üìì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h4>
                                  <div class="space-y-2">${journalHtml}</div>
                              </div>
                         </div>
                    </div>
                </div>
            `;
            renderHealthTrackerForDay(dateStr);
        }

        function renderHealthTrackerForDay(dateStr) {
             const container = document.getElementById('daily-health-view');
             if (!container) return;
             const logsToday = appState.health_log.filter(log => log.log_date === dateStr);
             const foodLogs = logsToday.filter(log => log.type === 'food');
             const exerciseLogs = logsToday.filter(log => log.type === 'exercise');
             const caloriesIn = foodLogs.reduce((sum, log) => sum + log.calories, 0);
             const caloriesOut = exerciseLogs.reduce((sum, log) => sum + log.calories, 0);
             const calorieGoal = 1850;
             const remainingCalories = calorieGoal - (caloriesIn - caloriesOut);
             
             container.innerHTML = `
                 <div class="grid grid-cols-3 gap-2 text-center text-sm mb-2">
                      <div class="bg-green-100 p-2 rounded-lg"><p class="text-xs text-green-800">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p><p class="font-bold text-green-600">${formatNumber(caloriesIn)}</p></div>
                      <div class="bg-orange-100 p-2 rounded-lg"><p class="text-xs text-orange-800">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</p><p class="font-bold text-orange-600">${formatNumber(caloriesOut)}</p></div>
                      <div class="bg-blue-100 p-2 rounded-lg"><p class="text-xs text-blue-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p class="font-bold text-blue-600">${formatNumber(remainingCalories)}</p></div>
                 </div>
             `;
        }
        
        // --- DRAG AND DROP FOR HABITS ---
        function addDragDropListeners(container) {
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('habit-item')) {
                    e.target.classList.add('dragging');
                }
            });

            container.addEventListener('dragend', e => {
                if (e.target.classList.contains('habit-item')) {
                    e.target.classList.remove('dragging');
                }
            });

            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    if (afterElement == null) {
                        container.appendChild(draggable);
                    } else {
                        container.insertBefore(draggable, afterElement);
                    }
                }
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                const habitElements = [...container.querySelectorAll('.habit-item')];
                const updates = habitElements.map((habitEl, index) => {
                    return {
                        id: parseInt(habitEl.dataset.id),
                        sort_order: index
                    };
                });
                
                const { error } = await db.from('habits').upsert(updates);
                if (error) {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ', 'error');
                    console.error(error);
                } else {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    fetchAllData(); // Refresh data to ensure consistency
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.habit-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- BACKLOG HABITS ---
        async function backlogYesterdayHabits() {
            const YESTERDAY = '2025-08-11';
            const HABIT_NAMES = ['‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', '‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 1 ‡πÄ‡∏•‡πà‡∏°', '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö activity book 1 ‡∏´‡∏ô‡πâ‡∏≤'];

            const { data: habits, error: habitsError } = await db.from('habits').select('id, name');
            const { data: logs, error: logsError } = await db.from('habit_log').select('habit_id').eq('completed_date', YESTERDAY);

            if (habitsError || logsError) {
                console.error("Could not fetch data for backlogging habits", habitsError, logsError);
                return;
            }

            const loggedHabitIds = new Set(logs.map(l => l.habit_id));
            const habitsToLog = [];

            for (const habitName of HABIT_NAMES) {
                const habit = habits.find(h => h.name === habitName);
                if (habit && !loggedHabitIds.has(habit.id)) {
                    habitsToLog.push({ habit_id: habit.id, completed_date: YESTERDAY });
                }
            }

            if (habitsToLog.length > 0) {
                const { error } = await db.from('habit_log').insert(habitsToLog);
                if (error) {
                    console.error("Error backlogging habits:", error);
                } else {
                    console.log(`Successfully backlogged ${habitsToLog.length} habits for yesterday.`);
                    fetchAllData();
                }
            }
        }

        // --- INITIALIZATION ---
        async function fetchAllData() {
            const tableNames = [
                'tasks', 'budget', 'schedules', 'okrs', 'ideas', 'habits', 
                'habit_log', 'health_log', 'mood_logs', 'media_logs', 'event_log', 
                'personal_growth', 'certificates', 'journal_entries', 'knowledge_base'
            ];
            
            const promises = tableNames.map(name => db.from(name).select('*'));
            
            const results = await Promise.all(promises);

            results.forEach((res, index) => {
                const tableName = tableNames[index];
                if (res.error) {
                    console.error(`Error fetching ${tableName}:`, res.error);
                    appState[tableName] = [];
                } else {
                    appState[tableName] = res.data || [];
                }
            });
            
            appState.knowledge_items = appState.knowledge_base;
            
            renderAllComponents();
        }

        function renderAllComponents() {
            renderDashboardOverview();
            renderWeeklyAgenda();
            renderOkrs();
            renderTaskBoard();
            renderIdeaBoard();
            renderCalendar();
            renderHabitTracker();
            renderHealthTracker();
            renderMoodTracker();
            renderMediaLog();
            renderEventLog();
            renderPersonalGrowth();
            renderCertificates();
            renderJournalEntries();
            renderKnowledgeGallery();
            renderBudget();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('dashboard-theme') || 'slate';
            setTheme(savedTheme);

            fetchAllData();
            backlogYesterdayHabits();

            document.getElementById('idea-search').addEventListener('input', (e) => {
                appState.filters.idea = e.target.value;
                renderIdeaBoard();
            });
            document.getElementById('event-search').addEventListener('input', (e) => {
                appState.filters.event = e.target.value;
                renderEventLog();
            });
            document.getElementById('knowledge-search').addEventListener('input', (e) => {
                appState.filters.knowledge = e.target.value;
                renderKnowledgeGallery();
            });


            const sections = document.querySelectorAll('main section');
            const navLinks = document.querySelectorAll('#sidebar-nav a');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.toggle('active', link.getAttribute('href').substring(1) === entry.target.id);
                        });
                    }
                });
            }, { rootMargin: "-50% 0px -50% 0px", threshold: 0 });

            sections.forEach(section => observer.observe(section));
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        toggleSidebar();
                    }
                });
            });
        });
    </script>
</body>
</html>
